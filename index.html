<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-IMS: Inventaris Komponen Elektronik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* General Transition Definition for Sidebar and Content */
        .sidebar {
            transition: width 0.3s ease;
        }
        .content {
            transition: padding-left 0.3s ease;
        }

        /* Sidebar Styling (Desktop) */
        .sidebar {
            width: 16rem; /* Default width for open state */
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 20;
        }
        .sidebar .logo {
            padding: 1rem;
        }
        .sidebar .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: #6b7280; /* gray-500 */
            transition: background-color 0.15s, color 0.15s;
        }
        .sidebar .nav-item:hover, .sidebar .nav-item.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
        }
        .sidebar .nav-item.active {
            font-weight: 600;
        }

        /* Main Content Styling (Desktop) */
        .main-container {
            padding-left: 16rem; /* Match sidebar width */
            transition: padding-left 0.3s ease;
            min-height: 100vh;
        }

        /* Sidebar Closed State (Desktop) */
        body.sidebar-closed .sidebar {
            width: 4rem;
        }
        body.sidebar-closed .sidebar .nav-text, 
        body.sidebar-closed .sidebar .logo-text,
        body.sidebar-closed .sidebar .footer-info {
            display: none;
        }
        body.sidebar-closed .sidebar .nav-item {
            justify-content: center;
            padding: 0.75rem 0;
        }
        body.sidebar-closed .main-container {
            padding-left: 4rem;
        }
        
        /* ---------------------------------------------------- */
        /* START: PRINT FIX STYLES */
        /* Ensure print-label-container (used dynamically) is hidden normally */
        .print-label-container {
             display: none;
        }
        
        /* New element to hold print content, hidden normally */
        #print-area-container {
            display: none; 
        }
        /* END: PRINT FIX STYLES */
        /* ---------------------------------------------------- */


        /* Custom Print Style for Barcode Label (32mm x 64mm) */
        @page {
            /* Landscape: width 64mm, height 32mm */
            size: 64mm 32mm; 
            margin: 0;
        }

        @media print {
            /* 1. HIDE the entire application UI wrapper */
            #app-wrapper {
                display: none !important; 
            }

            /* 2. SHOW the temporary print container */
            #print-area-container {
                display: flex !important;
                position: absolute;
                top: 0;
                left: 0;
                /* Ukuran kertas */
                width: 64mm; 
                height: 32mm;
                /* Reset standard print styles */
                margin: 0;
                padding: 1mm; 
                box-sizing: border-box;
                page-break-after: always; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            /* 3. Apply styles to the dynamic content inside the container */
            #print-area-container .print-label-container {
                /* Tampilkan inner container saat mode cetak */
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                /* Ukuran kertas */
                width: 100%; 
                height: 100%;
                /* Reset border/padding for actual print */
                margin: 0;
                padding: 0; 
                border: none;
                box-sizing: border-box;
            }


            /* Styling untuk SVG Barcode di mode cetak */
            #print-area-container svg {
                max-width: 60mm;
                height: 20mm; 
                margin-top: 0;
            }

            /* Styling untuk Nama/ID Barang di mode cetak */
            #print-area-container .print-name {
                font-size: 8pt; 
                line-height: 1.1;
                margin-top: 1mm;
                font-weight: bold;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
            }
             #print-area-container .print-id {
                font-size: 7pt; 
                line-height: 1;
                text-align: center;
                margin-bottom: 0;
                font-family: monospace;
            }

            /* Force the element to the top of the page */
            html, body {
                height: 100%;
                overflow: hidden;
            }
        }

        /* Responsive for mobile (Sidebar becomes bottom bar) */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                left: 0;
                border-top: 1px solid #e5e7eb; /* gray-200 */
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 0.5rem 0;
                z-index: 50;
                background-color: white;
            }
            .sidebar .nav-item {
                margin: 0;
                flex-direction: column;
                padding: 0.5rem 0.25rem;
                border-radius: 0;
                text-align: center;
            }
            .sidebar .nav-text {
                font-size: 0.65rem; /* Extra small text */
                margin-top: 0.25rem;
            }
            .sidebar .logo, 
            .sidebar .logo-text, 
            .sidebar .footer-info,
            .sidebar .sidebar-toggle-btn {
                display: none !important; /* Hide sidebar specific elements on mobile */
            }
            .main-container {
                padding-left: 0;
                padding-bottom: 4rem; /* Space for the bottom nav bar */
            }
            
            /* Remove desktop open/closed classes on mobile */
            body.sidebar-open .main-container, 
            body.sidebar-closed .main-container {
                padding-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 sidebar-open">

    <div id="app-wrapper">

        <nav id="sidebar" class="sidebar flex flex-col justify-between bg-white border-r border-gray-200 shadow-md md:shadow-none">
            <div>
                <div class="logo flex items-center p-4">
                    <i data-lucide="archive" class="w-6 h-6 text-indigo-600"></i>
                    <span class="logo-text text-xl font-bold ml-3 text-gray-800">E-IMS</span>
                </div>

                <div class="mt-6 flex flex-col space-y-1">
                    <a id="nav-dashboard" class="nav-item active" href="javascript:void(0)">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span class="nav-text ml-3">Dashboard</span>
                    </a>
                    <a id="nav-list" class="nav-item" href="javascript:void(0)">
                        <i data-lucide="list-ordered" class="w-5 h-5"></i>
                        <span class="nav-text ml-3">Inventaris</span>
                    </a>
                    <a id="nav-scan" class="nav-item" href="javascript:void(0)">
                        <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                        <span class="nav-text ml-3">Scan Barcode</span>
                    </a>
                </div>
            </div>

            <div class="p-4 border-t border-gray-200">
                <div class="footer-info text-xs text-gray-500 mb-2">
                    User: <span id="user-info" class="font-semibold text-gray-700">Loading...</span>
                </div>
                <div class="flex flex-col space-y-2">
                    <button id="logout-btn" class="w-full py-2 px-3 rounded-lg text-sm text-red-600 bg-red-50 hover:bg-red-100 transition flex items-center justify-center">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                        <span class="nav-text">Logout</span>
                    </button>
                    <button id="toggle-config-btn" class="w-full py-2 px-3 rounded-lg text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 transition flex items-center justify-center">
                        <i data-lucide="settings" class="w-4 h-4 inline mr-1" id="toggle-config-icon"></i> 
                        <span class="nav-text">Konfigurasi Lanjut</span>
                    </button>
                </div>
            </div>
        </nav>

        <div id="main-container" class="main-container">
            <header class="sticky top-0 bg-white p-4 border-b border-gray-200 flex justify-between items-center z-10">
                <h1 id="app-title" class="text-2xl font-bold text-gray-800">E-IMS</h1>
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle-btn" class="sidebar-toggle-btn p-2 rounded-full hover:bg-gray-100 transition hidden md:block">
                        <i data-lucide="chevrons-left" class="w-6 h-6 text-gray-600" id="toggle-icon"></i>
                    </button>
                    
                    <button id="add-item-btn" class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-1"></i>
                        <span class="hidden sm:inline">Tambah Barang</span>
                    </button>
                </div>
            </header>

            <div id="firebase-config-form" class="hidden p-4 bg-yellow-50 border-y border-yellow-200">
                <h3 class="text-lg font-bold text-yellow-800 mb-3">Konfigurasi Firebase</h3>
                <p class="text-sm text-yellow-700 mb-4">Gunakan ini hanya jika Anda ingin menghubungkan aplikasi ke proyek Firebase Anda sendiri. Setelah disimpan, aplikasi akan dimuat ulang.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">API Key</label>
                        <input type="text" id="config-apikey" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="AIzaSy...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Auth Domain</label>
                        <input type="text" id="config-authdomain" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="[project-id].firebaseapp.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Project ID</label>
                        <input type="text" id="config-projectid" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="your-project-id">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="save-config-btn" class="py-2 px-4 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white font-semibold">Simpan & Muat Ulang</button>
                </div>
            </div>

            <main class="p-4 md:p-8">

                <div id="login-view" class="app-view hidden max-w-lg mx-auto bg-white p-8 shadow-xl rounded-xl mt-16">
                    <h2 class="text-3xl font-extrabold text-indigo-600 mb-6 text-center">E-IMS Login</h2>
                    <p class="text-gray-600 mb-6 text-center">Silakan login atau register untuk mengakses inventaris.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="contoh@domain.com">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Minimal 6 karakter">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between space-x-4">
                        <button id="register-btn" class="w-1/2 py-3 px-4 border border-indigo-600 rounded-lg text-indigo-600 hover:bg-indigo-50 font-semibold transition">Register</button>
                        <button id="login-btn" class="w-1/2 py-3 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Login</button>
                    </div>
                </div>
                
                <div id="dashboard-view" class="app-view hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Inventaris</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Jenis Barang</p>
                                <p id="total-items" class="text-4xl font-extrabold text-indigo-600 mt-1">0</p>
                            </div>
                            <i data-lucide="box" class="w-10 h-10 text-indigo-400 opacity-50"></i>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Kuantitas Stok</p>
                                <p id="total-stock" class="text-4xl font-extrabold text-green-600 mt-1">0</p>
                            </div>
                            <i data-lucide="package" class="w-10 h-10 text-green-400 opacity-50"></i>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Barang Stok Minimum</p>
                                <p id="low-stock-count" class="text-4xl font-extrabold text-red-600 mt-1">0</p>
                            </div>
                            <i data-lucide="alert-triangle" class="w-10 h-10 text-red-400 opacity-50"></i>
                        </div>
                    </div>

                    <div id="low-stock-alert" class="hidden bg-red-50 p-6 rounded-xl border border-red-200">
                        <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center">
                            <i data-lucide="alert-circle" class="w-6 h-6 mr-2"></i> Peringatan Stok Minimum
                        </h3>
                        <ul id="low-stock-list" class="space-y-3">
                            </ul>
                    </div>
                </div>

                <div id="list-view" class="app-view hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Daftar Inventaris Komponen</h2>
                    
                    <div class="mb-6">
                        <input type="text" id="search-input" placeholder="Cari berdasarkan nama, nilai, package, atau lokasi..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div id="inventory-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        </div>
                </div>
                
                <div id="detail-view" class="app-view hidden">
                    <button id="back-to-list-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold mb-4 flex items-center">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Kembali ke Daftar
                    </button>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="lg:w-1/3 flex flex-col items-center">
                                <img id="detail-photo" src="https://placehold.co/150x150/A0A0A0/ffffff?text=E-Comp" alt="Foto Komponen" class="w-32 h-32 object-cover rounded-md mb-4 border border-gray-200">
                                
                                <h3 class="text-lg font-semibold text-gray-700">Stok Tersedia</h3>
                                <p class="text-5xl font-extrabold text-green-600 mt-1 mb-4">
                                    <span id="detail-stock">0</span>
                                    <span id="detail-unit" class="text-2xl font-bold text-gray-600 ml-1">pcs</span>
                                </p>
                                
                                <div class="flex space-x-3 w-full max-w-xs">
                                    <button id="stock-in-btn" class="w-1/2 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold transition flex items-center justify-center">
                                        <i data-lucide="arrow-down-to-line" class="w-5 h-5 mr-1"></i> Masuk
                                    </button>
                                    <button id="stock-out-btn" class="w-1/2 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 font-semibold transition flex items-center justify-center">
                                        <i data-lucide="arrow-up-from-line" class="w-5 h-5 mr-1"></i> Keluar
                                    </button>
                                </div>
                            </div>

                            <div class="lg:w-2/3">
                                <div class="flex justify-between items-start border-b pb-4 mb-4">
                                    <div>
                                        <h2 id="detail-name" class="text-3xl font-bold text-gray-800">Nama Komponen</h2>
                                        <p class="text-sm font-mono text-gray-500 mt-1">Kode: <span id="detail-id">N/A</span></p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="edit-item-btn" class="p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition">
                                            <i data-lucide="pencil" class="w-5 h-5"></i>
                                        </button>
                                        <button id="delete-item-btn" class="p-2 rounded-full text-red-600 hover:bg-red-100 transition">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-700 mb-6">
                                    <div><span class="font-semibold text-gray-500">Nilai/Spesifikasi:</span> <p id="detail-value" class="font-medium"></p></div>
                                    <div><span class="font-semibold text-gray-500">Package/Tipe:</span> <p id="detail-package" class="font-medium"></p></div>
                                    <div><span class="font-semibold text-gray-500">Brand/Merek:</span> <p id="detail-brand" class="font-medium"></p></div>
                                    <div><span class="font-semibold text-gray-500">Lokasi Rak:</span> <p id="detail-location" class="font-medium"></p></div>
                                    <div><span class="font-semibold text-gray-500">Stok Minumun:</span> <p id="detail-minstock" class="font-medium"></p></div>
                                    <div><span class="font-semibold text-gray-500">Kategori:</span> <p id="detail-category" class="font-medium"></p></div>
                                </div>

                                <div id="barcode-display">
                                    </div>
                            </div>
                        </div>

                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Riwayat Stok (50 Transaksi Terakhir)</h3>
                            <div id="item-history" class="bg-gray-50 rounded-lg border border-gray-200 divide-y divide-gray-200">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="scan-view" class="app-view hidden max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Scan Barcode / QR Code</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <div id="reader" class="w-full aspect-square border-4 border-dashed border-indigo-300 rounded-lg overflow-hidden">
                            </div>
                        <div id="scanner-result" class="text-center mt-4 p-3 bg-gray-100 rounded-lg">
                            <p class="text-gray-500">Pemindai belum aktif.</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="stopScanner(); showView('list');" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition flex items-center justify-center mx-auto">
                            <i data-lucide="x" class="w-5 h-5 mr-2"></i> Tutup Pemindai
                        </button>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <div id="item-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" data-mode="add">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
            <h3 id="item-form-title" class="text-2xl font-bold text-gray-800 mb-4">Tambah Komponen Baru</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Kode Barang (Wajib, unik)</label>
                        <input type="text" id="item-id" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: R001, C012">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Barang (Wajib)</label>
                        <input type="text" id="item-name" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: Resistor 10k, Arduino Uno">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Kategori</label>
                        <select id="item-category" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            <option value="Resistor">Resistor</option>
                            <option value="Kapasitor">Kapasitor</option>
                            <option value="Induktor">Induktor</option>
                            <option value="Semikonduktor">Semikonduktor</option>
                            <option value="IC">IC (Integrated Circuit)</option>
                            <option value="Modul">Modul</option>
                            <option value="Konektor">Konektor</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nilai/Spesifikasi (Wajib)</label>
                        <input type="text" id="item-value" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: 10k 1/4W, 100uF 50V, SMD 0805">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Package/Tipe</label>
                        <input type="text" id="item-package" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: DIP-8, TO-220, THT">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Brand/Merek</label>
                        <input type="text" id="item-brand" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: Texas Instrument, Murata">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Satuan Unit</label>
                        <input type="text" id="item-unit" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: pcs, gulung, meter" value="pcs">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lokasi Rak/Box (Wajib)</label>
                        <input type="text" id="item-location" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Cth: Rak A-01, Box 12">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Stok Minimum</label>
                        <input type="number" id="item-minstock" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Konten Barcode</label>
                        <input type="text" id="item-barcode" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Isi barcode (default: Kode Barang)">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="close-modal-btn py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Batal</button>
                <button id="save-item-btn" class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Simpan Komponen</button>
            </div>
        </div>
    </div>

    <div id="stock-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="stock-title" class="text-2xl font-bold text-gray-800 mb-4">Stok Masuk/Keluar</h3>
            <p class="text-gray-600 mb-4">Komponen: <span id="stock-component-name" class="font-semibold"></span></p>
            <p class="text-sm text-gray-500 mb-4">Stok Saat Ini: <span id="stock-current-stock" class="font-bold text-gray-700"></span></p>

            <div class="space-y-4">
                <input type="hidden" id="stock-type"> <div>
                    <label class="block text-sm font-medium text-gray-700">Kuantitas</label>
                    <input type="number" id="stock-quantity" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Masukkan jumlah barang" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Catatan (Keperluan / Proyek)</label>
                    <textarea id="stock-notes" class="mt-1 block w-full border border-gray-300 rounded-md p-2" rows="3" placeholder="Cth: Proyek 'Smart Home', Pembelian dari Supplier X"></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button class="close-modal-btn py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Batal</button>
                <button id="save-stock-btn" class="py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">Proses Transaksi</button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-3">Pesan</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="message-modal-close-btn" class="py-2 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Tutup</button>
        </div>
    </div>
    
    <div id="print-area-container" style="display: none;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Menggunakan setLogLevel('Debug') untuk melihat log detail di console
        setLogLevel('Debug');

        // --- Variabel Global Canvas (Harus Digunakan) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Mendapatkan Konfigurasi Firebase ---
        let firebaseConfig = null;
        const savedConfig = localStorage.getItem('eims_firebase_config');

        if (savedConfig) {
            try {
                firebaseConfig = JSON.parse(savedConfig);
                console.log("Menggunakan konfigurasi Firebase dari Local Storage.");
            } catch (e) {
                console.error("Gagal memparsing konfigurasi Firebase dari Local Storage. Menggunakan default/Canvas.", e);
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyDLlc2nBOG6hesoQmhTD55BuRc5l7UF87I",
                    authDomain: "batmon-5c279.firebaseapp.com",
                    databaseURL: "https://batmon-5c279-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "batmon-5c279",
                    storageBucket: "batmon-5c279.firebasestorage.app",
                    messagingSenderId: "718766895236",
                    appId: "1:718766895236:web:898d4cd85941d98dcd52d1"
                };
            }
        } else {
             firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyDLlc2nBOG6hesoQmhTD55BuRc5l7UF87I",
                authDomain: "batmon-5c279.firebaseapp.com",
                databaseURL: "https://batmon-5c279-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "batmon-5c279",
                storageBucket: "batmon-5c279.firebasestorage.app",
                messagingSenderSenderId: "718766895236",
                appId: "1:718766895236:web:898d4cd85941d98dcd52d1"
            };
        }
        
        // --- Inisialisasi Firebase ---
        let app = null;
        let auth = null;
        let db = null;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Gagal menginisialisasi Firebase dengan konfigurasi yang diberikan:", e);
            // Tampilkan pesan error di UI jika inisialisasi gagal
            window.onload = () => {
                getEl('login-view').classList.remove('hidden');
                showMessageModal('Error Fatal', 'Gagal menginisialisasi Firebase. Pastikan konfigurasi API Key dan Project ID sudah benar di "Konfigurasi Lanjut".');
            };
        }


        // --- Variabel State Aplikasi ---
        let userId = null;
        let userName = 'Anonim';
        let inventory = [];
        let transactions = [];
        let currentView = 'login'; // login, dashboard, list, detail, scan
        let selectedComponentId = null;
        let isAuthReady = false;
        let listenersAttached = false; // Flag untuk mencegah duplikasi listener
        let isSidebarOpen = true; // State untuk toggle sidebar

        // --- Referensi Koleksi Firestore (Publik) ---
        const getComponentColRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'components');
        const getTransactionColRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'transactions');

        // --- Helpers UI ---
        const getEl = (id) => document.getElementById(id);
        const hideAllViews = () => {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
        };
        const showView = (viewName) => {
            hideAllViews();
            const viewEl = getEl(`${viewName}-view`);
            if (viewEl) {
                viewEl.classList.remove('hidden');
            }
            currentView = viewName;

            // Logika spesifik per view
            if (viewName === 'scan') {
                startScanner();
            } else {
                stopScanner();
            }
            if (viewName === 'detail' && selectedComponentId) {
                renderComponentDetail();
            }
            if (viewName === 'list') {
                renderInventoryList();
            }
        };

        const showMessageModal = (title, message) => {
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('message-modal').classList.remove('hidden');
        };

        const closeModal = () => {
            getEl('message-modal').classList.add('hidden');
            getEl('item-form-modal').classList.add('hidden');
            getEl('stock-modal').classList.add('hidden');
        };

        // --- Sidebar Toggle Logic ---
        const toggleSidebar = () => {
            isSidebarOpen = !isSidebarOpen;
            const body = document.body;
            const toggleIcon = getEl('toggle-icon');

            if (isSidebarOpen) {
                body.classList.remove('sidebar-closed');
                body.classList.add('sidebar-open');
                toggleIcon.setAttribute('data-lucide', 'chevrons-left');
            } else {
                body.classList.remove('sidebar-open');
                body.classList.add('sidebar-closed');
                toggleIcon.setAttribute('data-lucide', 'chevrons-right');
            }
            // Re-render Lucide icons after changing attribute
            lucide.createIcons();
        };

        // --- Otentikasi dan Listener ---
        
        // Fungsi untuk penundaan dengan Exponential Backoff
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Mencoba otentikasi dengan exponential backoff
        const authenticate = async (maxRetries = 5) => {
            if (auth.currentUser) return;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas Auth successful.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Anonymous Auth successful.");
                    }
                    return; 
                } catch (error) {
                    const delayTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Auth failed, retrying in ${delayTime / 1000}s...`, error.message);
                    if (i < maxRetries - 1) {
                        await delay(delayTime);
                    } else {
                        console.error("Failed to authenticate after multiple retries.", error);
                    }
                }
            }
        };

        // Real-time listener untuk data komponen
        const setupInventoryListener = () => {
            if (!isAuthReady) return;

            const q = query(getComponentColRef());

            onSnapshot(q, (snapshot) => {
                inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                if (currentView === 'list') {
                    renderInventoryList();
                }
                if (currentView === 'detail' && selectedComponentId) {
                    renderComponentDetail();
                }
                console.log('Inventory Updated:', inventory.length, 'items');
            }, (error) => {
                console.error("Error fetching inventory:", error);
            });
        };

        // Real-time listener untuk data transaksi
        const setupTransactionListener = () => {
            if (!isAuthReady) return;

            const q = query(getTransactionColRef(), orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'detail' && selectedComponentId) {
                    renderComponentDetail();
                }
                console.log('Transactions Updated:', transactions.length, 'records');
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };

        const handleAuthChange = (user) => {
            if (user) {
                userId = user.uid;
                userName = user.email || 'Teknisi ' + user.uid.substring(0, 4);
                getEl('user-info').textContent = userName;
                isAuthReady = true;
                
                // Pindah ke Dashboard jika baru login
                if (currentView === 'login') {
                    showView('dashboard');
                }
                
                // Setup listeners *hanya sekali* setelah berhasil login
                if (!listenersAttached) {
                    setupInventoryListener();
                    setupTransactionListener();
                    listenersAttached = true;
                }

            } else {
                userId = null;
                isAuthReady = false;
                listenersAttached = false; // Reset jika log out
                showView('login');
            }
        };

        // Listener utama untuk perubahan status otentikasi
        if (auth) {
            onAuthStateChanged(auth, handleAuthChange);
        }
        
        // Memastikan otentikasi Canvas dijalankan jika token tersedia
        if (initialAuthToken && auth) {
            authenticate();
        }
        
        // --- Logika Konfigurasi Firebase ---
        const toggleFirebaseConfigForm = () => {
            const form = getEl('firebase-config-form');
            form.classList.toggle('hidden');
            const button = getEl('toggle-config-btn');
            if (form.classList.contains('hidden')) {
                button.innerHTML = '<i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Konfigurasi Lanjut';
            } else {
                 button.innerHTML = '<i data-lucide="settings-x" class="w-4 h-4 inline mr-1"></i> Sembunyikan Konfigurasi';
                 
                 // Isi form dengan config yang sedang berjalan (jika ada)
                 if (firebaseConfig) {
                     getEl('config-apikey').value = firebaseConfig.apiKey || '';
                     getEl('config-authdomain').value = firebaseConfig.authDomain || '';
                     getEl('config-projectid').value = firebaseConfig.projectId || '';
                 }
            }
            lucide.createIcons();
        };
        
        const saveFirebaseConfig = () => {
            const apiKey = getEl('config-apikey').value.trim();
            const authDomain = getEl('config-authdomain').value.trim();
            const projectId = getEl('config-projectid').value.trim();
            
            if (!apiKey || !projectId) {
                showMessageModal('Gagal Menyimpan', 'API Key dan Project ID wajib diisi.');
                return;
            }
            
            const newConfig = {
                apiKey: apiKey,
                authDomain: authDomain || `${projectId}.firebaseapp.com`,
                projectId: projectId,
                // Nilai default lain yang mungkin diperlukan
                storageBucket: `${projectId}.appspot.com`,
            };
            
            try {
                localStorage.setItem('eims_firebase_config', JSON.stringify(newConfig));
                showMessageModal('Berhasil', 'Konfigurasi Firebase baru telah disimpan. Aplikasi akan dimuat ulang untuk menggunakannya.');
                
                // Muat ulang aplikasi agar konfigurasi baru diterapkan
                setTimeout(() => window.location.reload(), 1500);
            } catch (e) {
                showMessageModal('Error', 'Gagal menyimpan konfigurasi ke Local Storage: ' + e.message);
            }
        };
        
        // --- Logika Login/Register ---
        getEl('login-btn').onclick = async () => {
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;
            
            if (!auth) {
                showMessageModal('Error', 'Firebase belum diinisialisasi. Cek Konfigurasi Lanjut.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessageModal('Berhasil', 'Login berhasil! Selamat datang.');
            } catch (error) {
                showMessageModal('Error Login', error.message);
            }
        };

        getEl('register-btn').onclick = async () => {
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;
            
            if (!auth) {
                showMessageModal('Error', 'Firebase belum diinisialisasi. Cek Konfigurasi Lanjut.');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessageModal('Berhasil', 'Registrasi dan Login berhasil! Selamat datang.');
            } catch (error) {
                showMessageModal('Error Register', error.message);
            }
        };

        getEl('logout-btn').onclick = async () => {
            try {
                await signOut(auth);
                // Modal akan tertutup dengan tombol 'Tutup' yang sudah diperbaiki
                showMessageModal('Informasi', 'Anda telah berhasil Logout.');
            } catch (error) {
                showMessageModal('Error Logout', error.message);
            }
        };


        // --- Fungsi CRUD Komponen ---

        const saveComponent = async () => {
            const id = getEl('item-id').value.trim();
            const name = getEl('item-name').value.trim();
            const category = getEl('item-category').value.trim();
            const value = getEl('item-value').value.trim();
            const pkg = getEl('item-package').value.trim();
            const brand = getEl('item-brand').value.trim();
            const location = getEl('item-location').value.trim();
            const minStock = parseInt(getEl('item-minstock').value) || 0;
            const unit = getEl('item-unit').value.trim();
            const barcodeContent = getEl('item-barcode').value.trim() || id;
            
            if (!id || !name || !value || !location) {
                showMessageModal('Gagal', 'Kode Barang, Nama, Spesifikasi, dan Lokasi wajib diisi.');
                return;
            }

            const isEditing = getEl('item-form-modal').dataset.mode === 'edit';
            const componentRef = isEditing ? doc(getComponentColRef(), selectedComponentId) : doc(getComponentColRef());

            const componentData = {
                itemId: id,
                name,
                category,
                value,
                package: pkg,
                brand,
                location,
                minStock,
                unit,
                barcodeContent,
                updatedAt: serverTimestamp(),
            };

            try {
                if (isEditing) {
                    await updateDoc(componentRef, componentData);
                    showMessageModal('Berhasil', 'Data komponen berhasil diperbarui.');
                } else {
                    // Cek duplikasi itemId sebelum tambah
                    const existingItem = inventory.find(item => item.itemId === id);
                    if (existingItem) {
                         showMessageModal('Gagal', 'Kode Barang sudah ada. Gunakan kode unik.');
                         return;
                    }
                    await setDoc(componentRef, {
                        ...componentData,
                        stock: 0,
                        photoUrl: 'https://placehold.co/100x100/A0A0A0/ffffff?text=E-Comp', // Placeholder foto
                        createdAt: serverTimestamp(),
                    });
                    showMessageModal('Berhasil', 'Komponen baru berhasil ditambahkan.');
                }
                closeModal();
            } catch (error) {
                showMessageModal('Error', 'Gagal menyimpan data komponen: ' + error.message);
            }
        };

        const deleteComponent = async (componentId) => {
            if (!confirm('Anda yakin ingin menghapus komponen ini? Semua riwayat stok juga akan terhapus.')) return;
            try {
                await deleteDoc(doc(getComponentColRef(), componentId));
                showMessageModal('Berhasil', 'Komponen berhasil dihapus.');
                showView('list');
            } catch (error) {
                showMessageModal('Error', 'Gagal menghapus komponen: ' + error.message);
            }
        };

        // --- Fungsi Transaksi Stok ---

        const updateStock = async () => {
            const type = getEl('stock-type').value; // 'IN' atau 'OUT'
            const quantity = parseInt(getEl('stock-quantity').value) || 0;
            const notes = getEl('stock-notes').value.trim();
            
            if (quantity <= 0) {
                showMessageModal('Gagal', 'Kuantitas harus lebih dari 0.');
                return;
            }

            if (!selectedComponentId) {
                showMessageModal('Gagal', 'ID Komponen tidak ditemukan.');
                return;
            }

            const component = inventory.find(i => i.id === selectedComponentId);

            if (!component) {
                 showMessageModal('Gagal', 'Komponen tidak ditemukan di database.');
                return;
            }

            const componentRef = doc(getComponentColRef(), selectedComponentId);
            const transactionRef = doc(getTransactionColRef());

            try {
                await runTransaction(db, async (transaction) => {
                    const componentDoc = await transaction.get(componentRef);
                    if (!componentDoc.exists()) {
                        throw "Dokumen Komponen tidak ditemukan!";
                    }

                    const currentStock = componentDoc.data().stock || 0;
                    const newStock = currentStock + (type === 'IN' ? quantity : -quantity);
                    
                    if (type === 'OUT' && currentStock < quantity) {
                        throw `Stok keluar (${quantity}) melebihi stok tersedia (${currentStock}).`;
                    }
                    
                    // Update Stok Komponen
                    transaction.update(componentRef, { 
                        stock: newStock,
                        updatedAt: serverTimestamp()
                    });

                    // Tambah Riwayat Transaksi
                    transaction.set(transactionRef, {
                        componentId: selectedComponentId,
                        itemId: component.itemId,
                        name: component.name,
                        type,
                        quantity,
                        newStock,
                        notes,
                        pic: userName,
                        timestamp: serverTimestamp(),
                    });
                });

                showMessageModal('Berhasil', `Stok ${component.name} berhasil diperbarui: ${type === 'IN' ? '+' : '-'}${quantity} ${component.unit}.`);
                closeModal();
            } catch (e) {
                showMessageModal('Error Transaksi', "Gagal melakukan transaksi: " + (e.message || e));
            }
        };
        
        // --- Fungsi Cetak Label Barcode (SUDAH DIPERBAIKI) ---
        const printBarcodeLabel = (printElementId) => {
            const printContent = getEl(printElementId);
            // Elemen utama aplikasi dan kontainer cetak sementara
            const appWrapper = getEl('app-wrapper');
            const printAreaContainer = getEl('print-area-container');

            if (!printContent || !appWrapper || !printAreaContainer) {
                showMessageModal('Gagal Mencetak', 'Elemen cetak tidak ditemukan. Coba muat ulang halaman.');
                return;
            }
            
            // 1. Buat Konten Cetak (Gunakan container baru dan salin isinya)
            const tempDiv = document.createElement('div');
            tempDiv.className = 'print-label-container'; 
            tempDiv.innerHTML = printContent.innerHTML;

            // Ambil status toggle dari elemen di detail-view
            const nameToggle = getEl('toggle-print-name');
            const printNameEl = tempDiv.querySelector('.print-name');
            const printIdEl = tempDiv.querySelector('.print-id');
            const isNameVisible = nameToggle ? nameToggle.checked : true;

            // Terapkan visibility ke salinan (berdasarkan toggle)
            if (printNameEl) printNameEl.style.display = isNameVisible ? 'block' : 'none';
            if (printIdEl) printIdEl.style.display = isNameVisible ? 'block' : 'none';
            
            // 2. Masukkan konten cetak ke kontainer sementara
            printAreaContainer.innerHTML = '';
            printAreaContainer.appendChild(tempDiv);
            
            // 3. Sembunyikan UI Aplikasi utama dan tampilkan kontainer cetak
            appWrapper.style.display = 'none';
            printAreaContainer.style.display = 'block';

            // 4. Panggil dialog cetak
            window.print();
            
            // 5. Bersihkan/Kembalikan UI setelah cetak
            // Timeout adalah cara paling andal untuk menunggu dialog cetak ditutup
            setTimeout(() => {
                // Sembunyikan kontainer cetak dan bersihkan
                printAreaContainer.style.display = 'none';
                printAreaContainer.innerHTML = '';
                
                // Tampilkan kembali UI Aplikasi utama
                appWrapper.style.display = 'block';

                // KEMBALI KE DETAIL BARANG
                showView('detail'); 
                
                // Perbarui status aktif navigasi (nav-list)
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navItem = getEl(`nav-list`);
                if (navItem) {
                     navItem.classList.add('active');
                }
                
                // Render ulang icon Lucide (PENTING)
                if (window.lucide && window.lucide.createIcons) {
                     window.lucide.createIcons();
                }
                
            }, 500); // Penundaan 500ms
        };
        
        // --- Fungsi Barcode (QRCode Generator & Barcode Renderer) ---
        // Menggunakan JsBarcode (via CDN) untuk merender Code-128
        const generateBarcodeDisplay = (content, name, itemId) => { // Pass itemId
            // ID unik untuk elemen SVG barcode agar bisa dirender oleh JsBarcode
            const barcodeId = `barcode-${selectedComponentId || Date.now()}`; 
            const printContainerId = `print-label-${selectedComponentId || Date.now()}`;
            
            // String HTML untuk tampilan Barcode (SVG)
            // KONTEN CETAK HANYA BARCODE, NAMA, DAN ID
            const displayHtml = `
                <div class="p-4 bg-white border border-gray-300 rounded-lg mt-4" id="barcode-container">
                    <h4 class="font-bold text-gray-700 mb-2">Barcode (Code-128)</h4>
                    
                    <div id="${printContainerId}" class="print-label-container flex flex-col justify-center items-center p-1 border-2 border-dashed border-gray-400">
                        <p class="print-id text-sm font-mono text-gray-800">${itemId}</p>
                        <svg id="${barcodeId}" class="mx-auto my-0"></svg>
                        <p class="print-name text-base font-semibold text-gray-800">${name}</p>
                    </div>

                    <div class="mt-4 flex flex-col items-center border-t pt-3 space-y-2">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-print-name" checked class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900">Sertakan Nama/ID Barang pada Label</span>
                        </label>
                        
                        <button id="print-barcode-btn" class="w-full max-w-xs py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold transition flex items-center justify-center">
                            <i data-lucide="printer" class="w-5 h-5 inline mr-2"></i> Cetak Label (32x64mm)
                        </button>
                    </div>

                </div>
            `;

            // Panggil JsBarcode setelah elemen SVG dimasukkan ke DOM.
            // Timeout 100ms digunakan untuk memastikan DOM telah diperbarui.
            setTimeout(() => {
                const svgElement = getEl(barcodeId);
                const printButton = getEl('print-barcode-btn');
                const nameToggle = getEl('toggle-print-name');
                const printNameEl = document.querySelector(`#${printContainerId} .print-name`);
                const printIdEl = document.querySelector(`#${printContainerId} .print-id`);

                if (svgElement && window.JsBarcode) {
                    try {
                        window.JsBarcode(`#${barcodeId}`, content, {
                            format: "CODE128", 
                            displayValue: false, 
                            width: 2,
                            height: 40, 
                            margin: 0, 
                            fontSize: 10,
                        });
                        console.log('Barcode rendered successfully for content:', content);

                        // Attach print handler after DOM update
                        if (printButton) {
                            printButton.onclick = () => printBarcodeLabel(printContainerId);
                            lucide.createIcons();
                        }
                        
                        // Handle toggle visibility in detail view
                        if (nameToggle) {
                            // Initial state based on 'checked' attribute
                            const isInitialChecked = nameToggle.checked;
                            if (printNameEl) printNameEl.classList.toggle('hidden', !isInitialChecked);
                            if (printIdEl) printIdEl.classList.toggle('hidden', !isInitialChecked);

                            // Handler for future changes
                            nameToggle.onchange = (e) => {
                                if (printNameEl) printNameEl.classList.toggle('hidden', !e.target.checked);
                                if (printIdEl) printIdEl.classList.toggle('hidden', !e.target.checked);
                            };
                        }


                    } catch (e) {
                        console.error("Gagal merender Barcode:", e);
                        svgElement.innerHTML = `<p class="text-red-500 text-sm">Error saat merender barcode: ${e.message}</p>`;
                    }
                }
            }, 100); 

            return displayHtml;
        };
        
        // --- Fungsi Barcode (Scanner) ---
        // Menggunakan library html5-qrcode via CDN
        let Html5Qrcode = window.Html5Qrcode;
        let html5QrcodeScanner = null;

        const startScanner = () => {
            if (!Html5Qrcode) {
                getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Error: Library Scanner tidak tersedia. Memuat ulang...</p>`;
                loadScannerLibrary(startScanner); // Coba muat ulang dan panggil fungsi ini lagi
                return;
            }

            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.clear(); 
                } catch(e) {
                    // ignore
                }
            }

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const onScanSuccess = (decodedText, decodedResult) => {
                stopScanner();
                handleScannedBarcode(decodedText);
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 }, disableFlip: false };
            
            // Coba mendapatkan kamera, jika gagal tampilkan pesan error
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        (errorMessage) => {
                            // Pesan error scan minor
                        }
                    ).catch((err) => {
                        getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal memulai scanner: ${err.message}</p>`;
                        console.error("Error starting scanner:", err);
                    });
                    getEl('scanner-result').innerHTML = `<p class="text-blue-500 font-bold">Siap memindai... Arahkan kamera ke Barcode/QR Code.</p>`;
                } else {
                    getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal: Tidak ada kamera yang terdeteksi pada perangkat ini.</p>`;
                }
            }).catch(err => {
                getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal: Izin kamera ditolak atau tidak terdeteksi: ${err.message}</p>`;
            });
        };
        
        // --- LOGIKA TOMBOL TUTUP SCANNER ---
        const stopScanner = () => {
            if (html5QrcodeScanner) {
                // 1. Coba hentikan aliran kamera secara asinkron
                try {
                    if (html5QrcodeScanner.isScanning) {
                        html5QrcodeScanner.stop()
                            .then(() => console.log("Scanner stream stopped gracefully."))
                            .catch((err) => console.warn("Error stopping scanner stream (stream might be already stopped):", err));
                    }
                } catch (e) {
                    console.warn("Error trying to stop scanner stream:", e);
                }

                // 2. Coba bersihkan elemen DOM dan state internal
                try {
                    html5QrcodeScanner.clear();
                } catch (e) {
                    console.warn("Error clearing scanner element/state:", e);
                }
                
                // 3. Reset variabel global
                html5QrcodeScanner = null;
                getEl('scanner-result').innerHTML = `<p class="text-gray-500">Pemindai ditutup.</p>`;
            }
        };
        // --- END LOGIKA TOMBOL TUTUP SCANNER ---

        const handleScannedBarcode = (barcode) => {
            // 1. Tampilkan hasil scan dan status pencarian
            getEl('scanner-result').innerHTML = `<p class="text-green-600 font-bold">Kode terdeteksi: ${barcode}. Mencari data...</p>`;
            
            const component = inventory.find(i => i.barcodeContent === barcode);

            if (component) {
                // KASUS DITEMUKAN
                selectedComponentId = component.id;
                
                // Tampilkan pesan "Ditemukan"
                showMessageModal('Ditemukan', `Komponen ${component.name} (${component.itemId}) ditemukan!`);
                
                // Tambahkan penundaan (500ms) agar pesan terlihat sebelum pindah view
                setTimeout(() => {
                    closeModal(); // Tutup modal pesan
                    showView('detail'); // Pindah ke detail barang
                }, 500);

            } else {
                // KASUS TIDAK DITEMUKAN
                // Tampilkan pesan "Tidak Ditemukan" dan kode barang
                showMessageModal('Tidak Ditemukan', `Barcode/Kode Barang "${barcode}" tidak ditemukan.`);
                
                // Tambahkan penundaan (500ms) agar pesan terlihat sebelum form muncul
                setTimeout(() => {
                    closeModal(); // Tutup modal pesan
                    
                    // Langsung buka form tambah komponen dan isi datanya
                    openItemFormModal('add');
                    getEl('item-id').value = barcode;
                    getEl('item-barcode').value = barcode;
                }, 500);
            }
        };

        // --- Render UI ---
        
        // Render Dashboard
        const renderDashboard = () => {
            if (!userId) return; 
            
            const totalItems = inventory.length;
            const totalStock = inventory.reduce((sum, item) => sum + (item.stock || 0), 0);
            
            const lowStockItems = inventory.filter(item => item.stock <= item.minStock && item.minStock > 0);
            const lowStockCount = lowStockItems.length;

            getEl('total-items').textContent = totalItems;
            getEl('total-stock').textContent = totalStock;
            getEl('low-stock-count').textContent = lowStockCount;

            const lowStockList = getEl('low-stock-list');
            lowStockList.innerHTML = '';
            
            if (lowStockCount > 0) {
                lowStockItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-red-100 rounded-lg cursor-pointer hover:bg-red-200 transition';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${item.name} (${item.value})</span>
                            <span class="text-sm font-mono bg-red-500 text-white px-2 py-1 rounded-full">${item.stock} ${item.unit}</span>
                        </div>
                        <p class="text-xs text-red-700 mt-1">Min: ${item.minStock} | Lokasi: ${item.location}</p>
                    `;
                    li.onclick = () => {
                        selectedComponentId = item.id;
                        showView('detail');
                    };
                    lowStockList.appendChild(li);
                });
                getEl('low-stock-alert').classList.remove('hidden');
            } else {
                 getEl('low-stock-alert').classList.add('hidden');
                 lowStockList.innerHTML = '<p class="text-center text-gray-500 p-4">Semua stok di atas batas minimum. Kerja bagus!</p>';
            }
        };

        // Render List Inventaris
        const renderInventoryList = (searchTerm = '') => {
            const listEl = getEl('inventory-list');
            listEl.innerHTML = '';

            const term = searchTerm.toLowerCase();
            const filteredInventory = inventory.filter(item => 
                item.name?.toLowerCase().includes(term) ||
                item.value?.toLowerCase().includes(term) ||
                item.package?.toLowerCase().includes(term) ||
                item.location?.toLowerCase().includes(term) ||
                item.itemId?.toLowerCase().includes(term)
            ).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            if (filteredInventory.length === 0) {
                listEl.innerHTML = `
                    <p class="text-center text-gray-500 p-8">
                        Tidak ada komponen yang ditemukan. 
                        ${term ? `Coba cari dengan kata kunci lain atau ` : ''} 
                        <span class="font-bold cursor-pointer text-blue-600 hover:text-blue-800" onclick="document.getElementById('add-item-btn').click()">
                            tambahkan komponen baru.
                        </span>
                    </p>
                `;
                return;
            }

            filteredInventory.forEach(item => {
                const isLowStock = item.stock <= item.minStock && item.minStock > 0;
                const lowStockClass = isLowStock ? 'bg-red-100 border-red-400' : 'bg-white border-gray-200';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `p-4 border shadow-sm rounded-xl cursor-pointer hover:shadow-lg transition ${lowStockClass}`;
                itemDiv.onclick = () => {
                    selectedComponentId = item.id;
                    showView('detail');
                };
                
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${item.photoUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <p class="text-lg font-bold truncate">${item.name}</p>
                            <p class="text-sm text-gray-600 truncate">${item.value} | ${item.package || 'N/A'}</p>
                        </div>
                        <div class="flex flex-col items-end flex-shrink-0">
                            <span class="font-extrabold text-2xl ${isLowStock ? 'text-red-600' : 'text-green-600'}">${item.stock || 0}</span>
                            <span class="text-xs text-gray-500">${item.unit || 'pcs'}</span>
                            <span class="text-xs text-gray-500">Lok: ${item.location}</span>
                        </div>
                    </div>
                `;
                listEl.appendChild(itemDiv);
            });
        };

        // Render Detail Komponen
        const renderComponentDetail = () => {
            const item = inventory.find(i => i.id === selectedComponentId);
            const detailEl = getEl('item-detail');
            const historyEl = getEl('item-history');
            
            if (!item) {
                detailEl.innerHTML = '<p class="p-4 text-red-500">Komponen tidak ditemukan.</p>';
                return;
            }

            // Update UI Detail
            getEl('detail-name').textContent = item.name;
            getEl('detail-id').textContent = item.itemId;
            getEl('detail-stock').textContent = item.stock || 0;
            getEl('detail-unit').textContent = item.unit || 'pcs';
            getEl('detail-value').textContent = item.value;
            getEl('detail-package').textContent = item.package || '-';
            getEl('detail-brand').textContent = item.brand || '-';
            getEl('detail-location').textContent = item.location;
            getEl('detail-minstock').textContent = item.minStock || 0;
            getEl('detail-category').textContent = item.category || '-';
            getEl('detail-photo').src = item.photoUrl;

            // Barcode Display (Pass itemId as well)
            getEl('barcode-display').innerHTML = generateBarcodeDisplay(item.barcodeContent, item.name, item.itemId);

            // Button Edit & Delete
            getEl('edit-item-btn').onclick = () => openItemFormModal('edit', item);
            getEl('delete-item-btn').onclick = () => deleteComponent(item.id);

            // Button Stok Masuk/Keluar
            getEl('stock-in-btn').onclick = () => openStockModal('IN', item);
            getEl('stock-out-btn').onclick = () => openStockModal('OUT', item);

            // Render Riwayat Transaksi
            const itemHistory = transactions
                .filter(t => t.componentId === selectedComponentId)
                // Sort array in memory
                .sort((a, b) => {
                    const dateA = a.timestamp?.seconds || 0;
                    const dateB = b.timestamp?.seconds || 0;
                    return dateB - dateA;
                });
                
            historyEl.innerHTML = '';

            if (itemHistory.length === 0) {
                historyEl.innerHTML = '<p class="text-center text-gray-500 p-4">Belum ada riwayat transaksi.</p>';
            } else {
                itemHistory.forEach(t => {
                    const isIN = t.type === 'IN';
                    const colorClass = isIN ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const sign = isIN ? '+' : '-';
                    const date = t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A';
                    historyEl.innerHTML += `
                        <div class="p-3 border-b last:border-b-0 flex justify-between items-center ${isIN ? 'hover:bg-green-50' : 'hover:bg-red-50'} transition">
                            <div>
                                <span class="font-bold ${isIN ? 'text-green-600' : 'text-red-600'}">${isIN ? 'Stok Masuk' : 'Stok Keluar'}</span>
                                <p class="text-xs text-gray-500">Oleh: ${t.pic}</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold ${isIN ? 'text-green-700' : 'text-red-700'}">${sign}${t.quantity} ${item.unit}</span>
                                <p class="text-sm text-gray-600">Sisa: ${t.newStock}</p>
                                <p class="text-xs text-gray-500 mt-1 italic break-all max-w-[150px]">${t.notes}</p>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // --- Modals ---
        const openItemFormModal = (mode, item = {}) => {
            const formModal = getEl('item-form-modal');
            const formTitle = getEl('item-form-title');
            formModal.dataset.mode = mode;

            // Reset form
            getEl('item-id').value = '';
            getEl('item-name').value = '';
            getEl('item-category').value = 'Resistor';
            getEl('item-value').value = '';
            getEl('item-package').value = '';
            getEl('item-brand').value = '';
            getEl('item-location').value = '';
            getEl('item-minstock').value = '0';
            getEl('item-unit').value = 'pcs';
            getEl('item-barcode').value = '';
            getEl('item-id').readOnly = false;

            if (mode === 'edit') {
                formTitle.textContent = 'Edit Komponen: ' + item.name;
                getEl('item-id').value = item.itemId || '';
                getEl('item-name').value = item.name || '';
                getEl('item-category').value = item.category || 'Resistor';
                getEl('item-value').value = item.value || '';
                getEl('item-package').value = item.package || '';
                getEl('item-brand').value = item.brand || '';
                getEl('item-location').value = item.location || '';
                getEl('item-minstock').value = item.minStock || 0;
                getEl('item-unit').value = item.unit || 'pcs';
                getEl('item-barcode').value = item.barcodeContent || item.itemId || '';
                getEl('item-id').readOnly = true; // Jangan izinkan edit ID di mode edit
            } else { 
                // add mode
                formTitle.textContent = 'Tambah Komponen Baru';
            }
            formModal.classList.remove('hidden');
        };

        const openStockModal = (type, item) => {
            const modal = getEl('stock-modal');
            getEl('stock-type').value = type;
            getEl('stock-title').textContent = type === 'IN' ? 'Stok Masuk' : 'Stok Keluar';
            getEl('stock-component-name').textContent = item.name;
            getEl('stock-current-stock').textContent = `${item.stock} ${item.unit}`;
            getEl('stock-quantity').value = '';
            getEl('stock-notes').value = '';
            modal.classList.remove('hidden');
        };

        // --- Event Listeners UI Global ---

        // Panggil fungsi ini untuk memasang semua event listener
        const initListeners = () => {
             // Navigasi
            const handleNavClick = (viewName) => {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                getEl(`nav-${viewName}`).classList.add('active');
                showView(viewName);
            };

            // Pastikan listener hanya dipasang sekali
            if (listenersAttached) return;

            getEl('nav-dashboard').onclick = () => handleNavClick('dashboard');
            getEl('nav-list').onclick = () => handleNavClick('list');
            getEl('nav-scan').onclick = () => handleNavClick('scan');
            getEl('sidebar-toggle-btn').onclick = toggleSidebar;

            // Pencarian Cepat
            getEl('search-input').oninput = (e) => renderInventoryList(e.target.value);

            // Tombol Tambah Komponen
            getEl('add-item-btn').onclick = () => openItemFormModal('add');

            // Tombol Simpan Komponen
            getEl('save-item-btn').onclick = saveComponent;

            // Tombol Simpan Transaksi
            getEl('save-stock-btn').onclick = updateStock;

            // Tombol Konfigurasi Firebase
            getEl('toggle-config-btn').onclick = toggleFirebaseConfigForm;
            getEl('save-config-btn').onclick = saveFirebaseConfig;

            // Tombol Tutup Modal
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.onclick = closeModal;
            });

            // Tombol Tutup Modal Pesan (Penting untuk mengatasi masalah logout)
            getEl('message-modal-close-btn').onclick = closeModal;

            // FIX: Tombol Kembali di Detail View
            const backToListBtn = getEl('back-to-list-btn');
            if (backToListBtn) {
                backToListBtn.onclick = () => {
                    // Panggil showView
                    showView('list');
                    // Perbarui status aktif navigasi
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    getEl('nav-list').classList.add('active');
                };
            }
        };

        // Inisialisasi utama (mengganti inisialisasi yang terpisah di file asli)
        const initApp = () => {
             // 1. Setup listeners (Dipisah agar bisa dipanggil ulang)
             initListeners();

             // 2. Terapkan status sidebar awal
             document.body.classList.add('sidebar-open');
             const toggleIcon = getEl('toggle-icon');
             if (toggleIcon) {
                 toggleIcon.setAttribute('data-lucide', 'chevrons-left'); // Set icon awal
                 lucide.createIcons(); // Render icon
             }

             // 3. Muat library scanner secara non-blocking
             loadScannerLibrary();
            
             // 4. Cek Auth dan tampilkan view yang sesuai
             if (!auth || !auth.currentUser) {
                 showView('login');
             } else {
                 showView('dashboard');
             }
        };

        // Load Barcode Scanner Library (html5-qrcode)
        const loadScannerLibrary = (callback = null) => {
            if (typeof Html5Qrcode === 'undefined' && !document.querySelector('script[src*="html5-qrcode"]')) {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/html5-qrcode';
                document.head.appendChild(script);
                script.onload = () => {
                    console.log('html5-qrcode loaded.');
                    // Set the global reference after successful load
                    Html5Qrcode = window.Html5Qrcode;
                    if (callback) callback();
                };
                script.onerror = () => {
                    console.error('Failed to load html5-qrcode.');
                };
            } else if (callback) {
                callback();
            }
        };

        // Inisialisasi awal aplikasi
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
