const exportAllToPNG = async () => {
    if (inventory.length === 0) {
        showMessageModal('Info', 'Tidak ada data untuk diexport.');
        return;
    }

    showMessageModal('Proses...', 'Sedang mengenerate gambar kualitas tinggi...');

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    document.body.appendChild(tempContainer);

    for (const item of inventory) {
        const labelWrapper = document.createElement('div');
        labelWrapper.style.width = '121px'; 
        labelWrapper.style.height = '242px';
        labelWrapper.style.background = 'white';
        labelWrapper.style.color = 'black';
        labelWrapper.style.display = 'flex';
        labelWrapper.style.flexDirection = 'column';
        labelWrapper.style.padding = '8px';
        labelWrapper.style.boxSizing = 'border-box';
        labelWrapper.style.border = '2px solid black';
        labelWrapper.style.fontFamily = 'sans-serif';

        // 1. Generate QR Code dengan SCALE LEBIH TINGGI (DETAIL)
        const canvasQR = document.createElement('canvas');
        try {
            bwipjs.toCanvas(canvasQR, {
                bcid: 'qrcode',
                text: item.itemId,
                scale: 5,           // Ditingkatkan dari 3 ke 5 untuk detail tajam
                includetext: false,
                padding: 0
            });
        } catch (e) { console.error(e); }

        // 2. Susun HTML
        labelWrapper.innerHTML = `
            <div style="flex: 0 0 98px; width: 98px; height: 98px; display: flex; justify-content: center; align-items: center; align-self: center; margin-bottom: 4px; overflow: hidden;">
                <img src="${canvasQR.toDataURL('image/png')}" 
                     style="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: crisp-edges;">
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: center; overflow: hidden; min-height: 0;">
                <div style="font-size: 18px; font-weight: 900; text-transform: uppercase; line-height: 1.1; word-break: break-word;">
                    ${item.name}
                </div>
            </div>
            <div style="flex: 0 0 auto; margin-top: auto; font-family: monospace; font-size: 10px; border-top: 1px solid black; width: 100%; text-align: center; padding-top: 4px;">
                ${item.itemId}
            </div>
        `;

        tempContainer.appendChild(labelWrapper);

        // 3. Konversi ke Gambar dengan Scale Tinggi
        try {
            const canvasResult = await html2canvas(labelWrapper, {
                scale: 4, // Ditingkatkan ke 4 agar hasil akhir sangat tajam saat diprint
                backgroundColor: "#ffffff",
                logging: false,
                useCORS: true
            });

            const link = document.createElement('a');
            link.download = `label_${item.itemId}.png`;
            link.href = canvasResult.toDataURL('image/png', 1.0); // Kualitas 1.0 (maksimal)
            link.click();
        } catch (err) {
            console.error("Gagal export:", err);
        }

        tempContainer.removeChild(labelWrapper);
    }

    document.body.removeChild(tempContainer);
    closeModal();
};
