<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-IMS: Inventaris Komponen Elektronik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Menggunakan setLogLevel('Debug') untuk melihat log detail di console
        setLogLevel('Debug');

        // --- Variabel Global Canvas (Harus Digunakan) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Mendapatkan Konfigurasi Firebase ---
        let firebaseConfig = null;
        const savedConfig = localStorage.getItem('eims_firebase_config');

        if (savedConfig) {
            try {
                firebaseConfig = JSON.parse(savedConfig);
                console.log("Menggunakan konfigurasi Firebase dari Local Storage.");
            } catch (e) {
                console.error("Gagal memparsing konfigurasi Firebase dari Local Storage. Menggunakan default/Canvas.", e);
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyDLlc2nBOG6hesoQmhTD55BuRc5l7UF87I",
                    authDomain: "batmon-5c279.firebaseapp.com",
                    databaseURL: "https://batmon-5c279-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "batmon-5c279",
                    storageBucket: "batmon-5c279.firebasestorage.app",
                    messagingSenderId: "718766895236",
                    appId: "1:718766895236:web:898d4cd85941d98dcd52d1"
                };
            }
        } else {
             firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyDLlc2nBOG6hesoQmhTD55BuRc5l7UF87I",
                authDomain: "batmon-5c279.firebaseapp.com",
                databaseURL: "https://batmon-5c279-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "batmon-5c279",
                storageBucket: "batmon-5c279.firebasestorage.app",
                messagingSenderId: "718766895236",
                appId: "1:718766895236:web:898d4cd85941d98dcd52d1"
            };
        }
        
        // --- Inisialisasi Firebase ---
        let app = null;
        let auth = null;
        let db = null;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Gagal menginisialisasi Firebase dengan konfigurasi yang diberikan:", e);
            // Tampilkan pesan error di UI jika inisialisasi gagal
            window.onload = () => {
                getEl('login-view').classList.remove('hidden');
                showMessageModal('Error Fatal', 'Gagal menginisialisasi Firebase. Pastikan konfigurasi API Key dan Project ID sudah benar di "Konfigurasi Lanjut".');
            };
        }


        // --- Variabel State Aplikasi ---
        let userId = null;
        let userName = 'Anonim';
        let inventory = [];
        let transactions = [];
        let currentView = 'login'; // login, dashboard, list, detail, scan
        let selectedComponentId = null;
        let isAuthReady = false;
        let listenersAttached = false; // Flag untuk mencegah duplikasi listener
        let isSidebarOpen = true; // State untuk toggle sidebar

        // --- Referensi Koleksi Firestore (Publik) ---
        const getComponentColRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'components');
        const getTransactionColRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'transactions');

        // --- Helpers UI ---
        const getEl = (id) => document.getElementById(id);
        const hideAllViews = () => {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
        };
        const showView = (viewName) => {
// PROTEKSI: Jika user tidak login dan mencoba akses selain login-view, paksa ke login
    if (!userId && viewName !== 'login') {
        viewName = 'login';
    }
            hideAllViews();
            const viewEl = getEl(`${viewName}-view`);
            if (viewEl) {
                viewEl.classList.remove('hidden');
            }
            currentView = viewName;

            // Logika spesifik per view
            if (viewName === 'scan') {
                startScanner();
            } else {
                stopScanner();
            }
            if (viewName === 'detail' && selectedComponentId) {
                renderComponentDetail();
            }
            if (viewName === 'list') {
                renderInventoryList();
            }
        };

        const showMessageModal = (title, message) => {
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('message-modal').classList.remove('hidden');
        };

        const closeModal = () => {
            getEl('message-modal').classList.add('hidden');
            getEl('item-form-modal').classList.add('hidden');
            getEl('stock-modal').classList.add('hidden');
        };

        // --- Sidebar Toggle Logic ---
        const toggleSidebar = () => {
            isSidebarOpen = !isSidebarOpen;
            const body = document.body;
            const toggleIcon = getEl('toggle-icon');

            if (isSidebarOpen) {
                body.classList.remove('sidebar-closed');
                body.classList.add('sidebar-open');
                toggleIcon.setAttribute('data-lucide', 'chevrons-left');
            } else {
                body.classList.remove('sidebar-open');
                body.classList.add('sidebar-closed');
                toggleIcon.setAttribute('data-lucide', 'chevrons-right');
            }
            // Re-render Lucide icons after changing attribute
            lucide.createIcons();
        };

        // --- Otentikasi dan Listener ---
        
        // Fungsi untuk penundaan dengan Exponential Backoff
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Mencoba otentikasi dengan exponential backoff
        const authenticate = async (maxRetries = 5) => {
            if (auth.currentUser) return;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas Auth successful.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Anonymous Auth successful.");
                    }
                    return; 
                } catch (error) {
                    const delayTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Auth failed, retrying in ${delayTime / 1000}s...`, error.message);
                    if (i < maxRetries - 1) {
                        await delay(delayTime);
                    } else {
                        console.error("Failed to authenticate after multiple retries.", error);
                    }
                }
            }
        };

        // Real-time listener untuk data komponen
        const setupInventoryListener = () => {
            if (!isAuthReady) return;

            const q = query(getComponentColRef());

            onSnapshot(q, (snapshot) => {
                inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                if (currentView === 'list') {
                    renderInventoryList();
                }
                if (currentView === 'detail' && selectedComponentId) {
                    renderComponentDetail();
                }
                console.log('Inventory Updated:', inventory.length, 'items');
            }, (error) => {
                console.error("Error fetching inventory:", error);
            });
        };

        // Real-time listener untuk data transaksi
        const setupTransactionListener = () => {
            if (!isAuthReady) return;

            const q = query(getTransactionColRef(), orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'detail' && selectedComponentId) {
                    renderComponentDetail();
                }
                console.log('Transactions Updated:', transactions.length, 'records');
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
        };

        const handleAuthChange = (user) => {
            if (user) {
                userId = user.uid;
                userName = user.email || 'Teknisi ' + user.uid.substring(0, 4);
                getEl('user-info').textContent = userName;
                isAuthReady = true;
                
       // Tampilkan sidebar HANYA jika ada user
        getEl('sidebar').classList.remove('hidden');

                // Pindah ke Dashboard jika baru login
                if (currentView === 'login') {
                    showView('dashboard');
                }
                
                // Setup listeners *hanya sekali* setelah berhasil login
                if (!listenersAttached) {
                    setupInventoryListener();
                    setupTransactionListener();
                    listenersAttached = true;
                }

            } else {
                userId = null;
                isAuthReady = false;
                listenersAttached = false; // Reset jika log out
                // Pastikan sidebar tersembunyi
        getEl('sidebar').classList.add('hidden'); 
        showView('login');
            }
        };

        // Listener utama untuk perubahan status otentikasi
        if (auth) {
            onAuthStateChanged(auth, handleAuthChange);
        }
        
        // Memastikan otentikasi Canvas dijalankan jika token tersedia
        if (initialAuthToken && auth) {
            authenticate();
        }
        
        // --- Logika Konfigurasi Firebase ---
        const toggleFirebaseConfigForm = () => {
            const form = getEl('firebase-config-form');
            form.classList.toggle('hidden');
            const button = getEl('toggle-config-btn');
            if (form.classList.contains('hidden')) {
                button.innerHTML = '<i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Konfigurasi Lanjut';
            } else {
                 button.innerHTML = '<i data-lucide="settings-x" class="w-4 h-4 inline mr-1"></i> Sembunyikan Konfigurasi';
                 
                 // Isi form dengan config yang sedang berjalan (jika ada)
                 if (firebaseConfig) {
                     getEl('config-apikey').value = firebaseConfig.apiKey || '';
                     getEl('config-authdomain').value = firebaseConfig.authDomain || '';
                     getEl('config-projectid').value = firebaseConfig.projectId || '';
                 }
            }
            lucide.createIcons();
        };
        
        const saveFirebaseConfig = () => {
            const apiKey = getEl('config-apikey').value.trim();
            const authDomain = getEl('config-authdomain').value.trim();
            const projectId = getEl('config-projectid').value.trim();
            
            if (!apiKey || !projectId) {
                showMessageModal('Gagal Menyimpan', 'API Key dan Project ID wajib diisi.');
                return;
            }
            
            const newConfig = {
                apiKey: apiKey,
                authDomain: authDomain || `${projectId}.firebaseapp.com`,
                projectId: projectId,
                // Nilai default lain yang mungkin diperlukan
                storageBucket: `${projectId}.appspot.com`,
            };
            
            try {
                localStorage.setItem('eims_firebase_config', JSON.stringify(newConfig));
                showMessageModal('Berhasil', 'Konfigurasi Firebase baru telah disimpan. Aplikasi akan dimuat ulang untuk menggunakannya.');
                
                // Muat ulang aplikasi agar konfigurasi baru diterapkan
                setTimeout(() => window.location.reload(), 1500);
            } catch (e) {
                showMessageModal('Error', 'Gagal menyimpan konfigurasi ke Local Storage: ' + e.message);
            }
        };
        
        // --- Logika Login/Register ---
        getEl('login-btn').onclick = async () => {
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;
            const rememberMe = getEl('remember-me').checked;
            
            if (!auth) {
                showMessageModal('Error', 'Firebase belum diinisialisasi. Cek Konfigurasi Lanjut.');
                return;
            }

            try {
                if (rememberMe) {
                    localStorage.setItem('eims_remembered_email', email);
                } else {
                    localStorage.removeItem('eims_remembered_email');
                }
                await signInWithEmailAndPassword(auth, email, password);
                showMessageModal('Berhasil', 'Login berhasil! Selamat datang.');
            } catch (error) {
                showMessageModal('Error Login', error.message);
            }
        };

        getEl('register-btn').onclick = async () => {
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;
            
            if (!auth) {
                showMessageModal('Error', 'Firebase belum diinisialisasi. Cek Konfigurasi Lanjut.');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessageModal('Berhasil', 'Registrasi dan Login berhasil! Selamat datang.');
            } catch (error) {
                showMessageModal('Error Register', error.message);
            }
        };

        getEl('logout-btn').onclick = async () => {
    try {
        await signOut(auth);
        // Refresh halaman secara total setelah logout berhasil
        window.location.reload(); 
    } catch (error) {
        showMessageModal('Error Logout', error.message);
    }
};


        // --- Fungsi CRUD Komponen ---

        const saveComponent = async () => {
            const id = getEl('item-id').value.trim();
            const name = getEl('item-name').value.trim();
            const category = getEl('item-category').value.trim();
            const value = getEl('item-value').value.trim();
            const pkg = getEl('item-package').value.trim();
            const brand = getEl('item-brand').value.trim();
            const location = getEl('item-location').value.trim();
            const minStock = parseInt(getEl('item-minstock').value) || 0;
            const unit = getEl('item-unit').value.trim();
            const barcodeContent = getEl('item-barcode').value.trim() || id;
            
            if (!id || !name || !value || !location) {
                showMessageModal('Gagal', 'Kode Barang, Nama, Spesifikasi, dan Lokasi wajib diisi.');
                return;
            }

            const isEditing = getEl('item-form-modal').dataset.mode === 'edit';
            const componentRef = isEditing ? doc(getComponentColRef(), selectedComponentId) : doc(getComponentColRef());

            const componentData = {
                itemId: id,
                name,
                category,
                value,
                package: pkg,
                brand,
                location,
                minStock,
                unit,
                barcodeContent,
                updatedAt: serverTimestamp(),
            };

            try {
                if (isEditing) {
                    await updateDoc(componentRef, componentData);
                    showMessageModal('Berhasil', 'Data komponen berhasil diperbarui.');
                } else {
                    // Cek duplikasi itemId sebelum tambah
                    const existingItem = inventory.find(item => item.itemId === id);
                    if (existingItem) {
                         showMessageModal('Gagal', 'Kode Barang sudah ada. Gunakan kode unik.');
                         return;
                    }
                    await setDoc(componentRef, {
                        ...componentData,
                        stock: 0,
                        photoUrl: 'https://placehold.co/100x100/A0A0A0/ffffff?text=E-Comp', // Placeholder foto
                        createdAt: serverTimestamp(),
                    });
                    showMessageModal('Berhasil', 'Komponen baru berhasil ditambahkan.');
                }
                closeModal();
            } catch (error) {
                showMessageModal('Error', 'Gagal menyimpan data komponen: ' + error.message);
            }
        };

        const deleteComponent = async (componentId) => {
            if (!confirm('Anda yakin ingin menghapus komponen ini? Semua riwayat stok juga akan terhapus.')) return;
            try {
                await deleteDoc(doc(getComponentColRef(), componentId));
                showMessageModal('Berhasil', 'Komponen berhasil dihapus.');
                showView('list');
            } catch (error) {
                showMessageModal('Error', 'Gagal menghapus komponen: ' + error.message);
            }
        };

        // --- Fungsi Transaksi Stok ---

        const updateStock = async () => {
            const type = getEl('stock-type').value; // 'IN' atau 'OUT'
            const quantity = parseInt(getEl('stock-quantity').value) || 0;
            const notes = getEl('stock-notes').value.trim();
            
            if (quantity <= 0) {
                showMessageModal('Gagal', 'Kuantitas harus lebih dari 0.');
                return;
            }

            if (!selectedComponentId) {
                showMessageModal('Gagal', 'ID Komponen tidak ditemukan.');
                return;
            }

            const component = inventory.find(i => i.id === selectedComponentId);

            if (!component) {
                 showMessageModal('Gagal', 'Komponen tidak ditemukan di database.');
                return;
            }

            const componentRef = doc(getComponentColRef(), selectedComponentId);
            const transactionRef = doc(getTransactionColRef());

            try {
                await runTransaction(db, async (transaction) => {
                    const componentDoc = await transaction.get(componentRef);
                    if (!componentDoc.exists()) {
                        throw "Dokumen Komponen tidak ditemukan!";
                    }

                    const currentStock = componentDoc.data().stock || 0;
                    const newStock = currentStock + (type === 'IN' ? quantity : -quantity);
                    
                    if (type === 'OUT' && currentStock < quantity) {
                        throw `Stok keluar (${quantity}) melebihi stok tersedia (${currentStock}).`;
                    }
                    
                    // Update Stok Komponen
                    transaction.update(componentRef, { 
                        stock: newStock,
                        updatedAt: serverTimestamp()
                    });

                    // Tambah Riwayat Transaksi
                    transaction.set(transactionRef, {
                        componentId: selectedComponentId,
                        itemId: component.itemId,
                        name: component.name,
                        type,
                        quantity,
                        newStock,
                        notes,
                        pic: userName,
                        timestamp: serverTimestamp(),
                    });
                });

                showMessageModal('Berhasil', `Stok ${component.name} berhasil diperbarui: ${type === 'IN' ? '+' : '-'}${quantity} ${component.unit}.`);
                closeModal();
            } catch (e) {
                showMessageModal('Error Transaksi', "Gagal melakukan transaksi: " + (e.message || e));
            }
        };
        
        // --- Fungsi Cetak Label Barcode ---
        const printBarcodeLabel = (printElementId) => {
            const printContent = getEl(printElementId);
            
            if (!printContent) {
                showMessageModal('Gagal Mencetak', 'Elemen cetak tidak ditemukan.');
                return;
            }
            
            // Cek status toggle untuk menyembunyikan/menampilkan nama/id
            const nameToggle = getEl('toggle-print-name');
            const printNameEl = document.querySelector(`#${printElementId} .print-name`);
            const printIdEl = document.querySelector(`#${printElementId} .print-id`);

            // Simpan status display asli sebelum mencetak
            const originalPrintNameDisplay = printNameEl ? printNameEl.style.display : 'block';
            const originalPrintIdDisplay = printIdEl ? printIdEl.style.display : 'block';
            
            // Terapkan visibility untuk cetak (jika toggle tidak aktif, sembunyikan)
            if (nameToggle && !nameToggle.checked) {
                if (printNameEl) printNameEl.style.display = 'none';
                if (printIdEl) printIdEl.style.display = 'none';
            } else {
                 // Pastikan terlihat jika toggle aktif
                if (printNameEl) printNameEl.style.display = 'block';
                if (printIdEl) printIdEl.style.display = 'block';
            }
            
            // Bungkus konten dalam div temporer
            const tempDiv = document.createElement('div');
            tempDiv.className = 'print-label-container'; // Class ini akan diisolasi oleh CSS @media print
            tempDiv.innerHTML = printContent.innerHTML;
            
            // Sisipkan div temporer ini ke body sebelum mencetak
            document.body.appendChild(tempDiv);
            
            // 4. Panggil dialog cetak
            window.print();
            
            // 5. Bersihkan/Kembalikan body setelah cetak
            setTimeout(() => {
                // Hapus div temporer
                document.body.removeChild(tempDiv);
                
                // Kembalikan status display asli
                if (printNameEl) printNameEl.style.display = originalPrintNameDisplay;
                if (printIdEl) printIdEl.style.display = originalPrintIdDisplay;
                
            }, 100); 
        };
        
        // --- Fungsi Barcode (QRCode Generator & Barcode Renderer) ---
        // Menggunakan JsBarcode (via CDN) untuk merender Code-128
        const generateBarcodeDisplay = (content, name, itemId) => { // Tambahkan itemId
            // ID unik untuk elemen SVG barcode agar bisa dirender oleh JsBarcode
            const barcodeId = `barcode-${selectedComponentId || Date.now()}`; 
            const printContainerId = `print-label-${selectedComponentId || Date.now()}`;
            
            // String HTML untuk tampilan Barcode (SVG)
            const displayHtml = `
                <div class="p-4 bg-white border border-gray-300 rounded-lg mt-4" id="barcode-container">
                    <h4 class="font-bold text-gray-700 mb-2">Barcode (Code-128)</h4>
                    
                    <div id="${printContainerId}" class="print-label-container flex flex-col justify-center items-center p-1 border-2 border-dashed border-gray-400">
                        <p class="print-id text-sm font-mono text-gray-800 hidden">${itemId}</p>
                        <svg id="${barcodeId}" class="mx-auto my-0"></svg>
                        <p class="print-name text-base font-semibold text-gray-800">${name}</p>
                    </div>

                    <div class="mt-4 flex flex-col items-center border-t pt-3 space-y-2">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-print-name" checked class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900">Sertakan Nama/ID Barang pada Label</span>
                        </label>
                        
                        <button id="print-barcode-btn" class="w-full max-w-xs py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold transition flex items-center justify-center">
                            <i data-lucide="printer" class="w-5 h-5 inline mr-2"></i> Cetak Label (32x64mm)
                        </button>
                    </div>

                </div>
            `;

            // Panggil JsBarcode setelah elemen SVG dimasukkan ke DOM.
            // Timeout 100ms digunakan untuk memastikan DOM telah diperbarui.
            setTimeout(() => {
                const svgElement = getEl(barcodeId);
                if (svgElement && window.JsBarcode) {
                    try {
                        window.JsBarcode(`#${barcodeId}`, content, {
                            format: "CODE128", // Format Code-128
                            displayValue: false, // JANGAN tampilkan di sini, karena teks akan dihandle terpisah
                            width: 2,
                            height: 40, // Sedikit lebih pendek
                            margin: 0, // Margin harus 0 agar pas
                            fontSize: 10,
                        });
                        console.log('Barcode rendered successfully for content:', content);

                        // Attach print handler after DOM update
                        const printButton = getEl('print-barcode-btn');
                        if (printButton) {
                            printButton.onclick = () => printBarcodeLabel(printContainerId);
                            // Ensure Lucide icons are rendered for the button
                            lucide.createIcons();
                        }
                        
                        // Attach toggle handler
                        const nameToggle = getEl('toggle-print-name');
                        const printNameEl = document.querySelector(`#${printContainerId} .print-name`);
                        const printIdEl = document.querySelector(`#${printContainerId} .print-id`);

                        if (nameToggle) {
                            // Handler untuk toggle
                            nameToggle.onchange = (e) => {
                                // Toggle visibility in the detail view
                                if (printNameEl) printNameEl.classList.toggle('hidden', !e.target.checked);
                                if (printIdEl) printIdEl.classList.toggle('hidden', !e.target.checked);
                            };
                            // Apply initial state based on 'checked'
                            if (printNameEl) printNameEl.classList.toggle('hidden', !nameToggle.checked);
                            if (printIdEl) printIdEl.classList.toggle('hidden', !nameToggle.checked);
                        }


                    } catch (e) {
                        console.error("Gagal merender Barcode:", e);
                        svgElement.innerHTML = `<p class="text-red-500 text-sm">Error saat merender barcode: ${e.message}</p>`;
                    }
                }
            }, 100); 

            return displayHtml;
        };
        
        // --- Fungsi Barcode (Scanner) ---
        // Menggunakan library html5-qrcode via CDN
        let Html5Qrcode = window.Html5Qrcode;
        let html5QrcodeScanner = null;

        const startScanner = () => {
            if (!Html5Qrcode) {
                getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Error: Library Scanner tidak tersedia. Memuat ulang...</p>`;
                loadScannerLibrary(startScanner); // Coba muat ulang dan panggil fungsi ini lagi
                return;
            }

            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.clear(); 
                } catch(e) {
                    // ignore
                }
            }

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const onScanSuccess = (decodedText, decodedResult) => {
                stopScanner();
                handleScannedBarcode(decodedText);
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 }, disableFlip: false };
            
            // Coba mendapatkan kamera, jika gagal tampilkan pesan error
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        (errorMessage) => {
                            // Pesan error scan minor
                        }
                    ).catch((err) => {
                        getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal memulai scanner: ${err.message}</p>`;
                        console.error("Error starting scanner:", err);
                    });
                    getEl('scanner-result').innerHTML = `<p class="text-blue-500 font-bold">Siap memindai... Arahkan kamera ke Barcode/QR Code.</p>`;
                } else {
                    getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal: Tidak ada kamera yang terdeteksi pada perangkat ini.</p>`;
                }
            }).catch(err => {
                getEl('scanner-result').innerHTML = `<p class="text-red-500 font-bold">Gagal: Izin kamera ditolak atau tidak terdeteksi: ${err.message}</p>`;
            });
        };
        
        // --- LOGIKA TOMBOL TUTUP SCANNER ---
        window.stopScanner = async function() {
        console.log("Mencoba menghentikan kamera...");
            if (html5QrcodeScanner) {
                // 1. Coba hentikan aliran kamera secara asinkron
                try {
                    if (html5QrcodeScanner.isScanning) {
                        html5QrcodeScanner.stop()
                            .then(() => console.log("Scanner stream stopped gracefully."))
                            .catch((err) => console.warn("Error stopping scanner stream (stream might be already stopped):", err));
                    }
                } catch (e) {
                    console.warn("Error trying to stop scanner stream:", e);
                }

                // 2. Coba bersihkan elemen DOM dan state internal
                try {
                    html5QrcodeScanner.clear();
                } catch (e) {
                    console.warn("Error clearing scanner element/state:", e);
                }
                
                // 3. Reset variabel global
                html5QrcodeScanner = null;
                getEl('scanner-result').innerHTML = `<p class="text-gray-500">Pemindai ditutup.</p>`;
                
            }
        };
        // --- END LOGIKA TOMBOL TUTUP SCANNER ---

        const handleScannedBarcode = (barcode) => {
            // 1. Tampilkan hasil scan dan status pencarian
            getEl('scanner-result').innerHTML = `<p class="text-green-600 font-bold">Kode terdeteksi: ${barcode}. Mencari data...</p>`;
            
            const component = inventory.find(i => i.barcodeContent === barcode);

            if (component) {
                // KASUS DITEMUKAN
                selectedComponentId = component.id;
                
                // Tampilkan pesan "Ditemukan"
                showMessageModal('Ditemukan', `Komponen ${component.name} (${component.itemId}) ditemukan!`);
                
                // Tambahkan penundaan (500ms) agar pesan terlihat sebelum pindah view
                setTimeout(() => {
                    closeModal(); // Tutup modal pesan
                    showView('detail'); // Pindah ke detail barang
                }, 500);

            } else {
                // KASUS TIDAK DITEMUKAN
                // Tampilkan pesan "Tidak Ditemukan" dan kode barang
                showMessageModal('Tidak Ditemukan', `Barcode/Kode Barang "${barcode}" tidak ditemukan.`);
                
                // Tambahkan penundaan (500ms) agar pesan terlihat sebelum form muncul
                setTimeout(() => {
                    closeModal(); // Tutup modal pesan
                    
                    // Langsung buka form tambah komponen dan isi datanya
                    openItemFormModal('add');
                    getEl('item-id').value = barcode;
                    getEl('item-barcode').value = barcode;
                }, 500);
            }
        };

        // --- Render UI ---
        
        // Render Dashboard
        const renderDashboard = () => {
            if (!userId) return; 
            
            const totalItems = inventory.length;
            const totalStock = inventory.reduce((sum, item) => sum + (item.stock || 0), 0);
            
            const lowStockItems = inventory.filter(item => item.stock <= item.minStock && item.minStock > 0);
            const lowStockCount = lowStockItems.length;

            getEl('total-items').textContent = totalItems;
            getEl('total-stock').textContent = totalStock;
            getEl('low-stock-count').textContent = lowStockCount;

            const lowStockList = getEl('low-stock-list');
            lowStockList.innerHTML = '';
            
            if (lowStockCount > 0) {
                lowStockItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-red-100 rounded-lg cursor-pointer hover:bg-red-200 transition';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${item.name} (${item.value})</span>
                            <span class="text-sm font-mono bg-red-500 text-white px-2 py-1 rounded-full">${item.stock} ${item.unit}</span>
                        </div>
                        <p class="text-xs text-red-700 mt-1">Min: ${item.minStock} | Lokasi: ${item.location}</p>
                    `;
                    li.onclick = () => {
                        selectedComponentId = item.id;
                        showView('detail');
                    };
                    lowStockList.appendChild(li);
                });
                getEl('low-stock-alert').classList.remove('hidden');
            } else {
                 getEl('low-stock-alert').classList.add('hidden');
                 lowStockList.innerHTML = '<p class="text-center text-gray-500 p-4">Semua stok di atas batas minimum. Kerja bagus!</p>';
            }
        };

        // Render List Inventaris
        const renderInventoryList = (searchTerm = '') => {
            const listEl = getEl('inventory-list');
            listEl.innerHTML = '';

            const term = searchTerm.toLowerCase();
            const filteredInventory = inventory.filter(item => 
                item.name?.toLowerCase().includes(term) ||
                item.value?.toLowerCase().includes(term) ||
                item.package?.toLowerCase().includes(term) ||
                item.location?.toLowerCase().includes(term) ||
                item.itemId?.toLowerCase().includes(term)
            ).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            if (filteredInventory.length === 0) {
                listEl.innerHTML = `
                    <p class="text-center text-gray-500 p-8">
                        Tidak ada komponen yang ditemukan. 
                        ${term ? `Coba cari dengan kata kunci lain atau ` : ''} 
                        <span class="font-bold cursor-pointer text-blue-600 hover:text-blue-800" onclick="document.getElementById('add-item-btn').click()">
                            tambahkan komponen baru.
                        </span>
                    </p>
                `;
                return;
            }

            filteredInventory.forEach(item => {
                const isLowStock = item.stock <= item.minStock && item.minStock > 0;
                const lowStockClass = isLowStock ? 'bg-red-100 border-red-400' : 'bg-white border-gray-200';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `p-4 border shadow-sm rounded-xl cursor-pointer hover:shadow-lg transition ${lowStockClass}`;
                itemDiv.onclick = () => {
                    selectedComponentId = item.id;
                    showView('detail');
                };
                
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${item.photoUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <p class="text-lg font-bold truncate">${item.name}</p>
                            <p class="text-sm text-gray-600 truncate">${item.value} | ${item.package || 'N/A'}</p>
                        </div>
                        <div class="flex flex-col items-end flex-shrink-0">
                            <span class="font-extrabold text-2xl ${isLowStock ? 'text-red-600' : 'text-green-600'}">${item.stock || 0}</span>
                            <span class="text-xs text-gray-500">${item.unit || 'pcs'}</span>
                            <span class="text-xs text-gray-500">Lok: ${item.location}</span>
                        </div>
                    </div>
                `;
                listEl.appendChild(itemDiv);
            });
        };

        // Render Detail Komponen
        const renderComponentDetail = () => {
            const item = inventory.find(i => i.id === selectedComponentId);
            const detailEl = getEl('item-detail');
            const historyEl = getEl('item-history');
            
            if (!item) {
                detailEl.innerHTML = '<p class="p-4 text-red-500">Komponen tidak ditemukan.</p>';
                return;
            }

            // Update UI Detail
            getEl('detail-name').textContent = item.name;
            getEl('detail-id').textContent = item.itemId;
            getEl('detail-stock').textContent = item.stock || 0;
            getEl('detail-unit').textContent = item.unit || 'pcs';
            getEl('detail-value').textContent = item.value;
            getEl('detail-package').textContent = item.package || '-';
            getEl('detail-brand').textContent = item.brand || '-';
            getEl('detail-location').textContent = item.location;
            getEl('detail-minstock').textContent = item.minStock || 0;
            getEl('detail-photo').src = item.photoUrl;

            // Barcode Display (Pass itemId as well)
            getEl('barcode-display').innerHTML = generateBarcodeDisplay(item.barcodeContent, item.name, item.itemId);
            
            // Button Edit & Delete
            getEl('edit-item-btn').onclick = () => openItemFormModal('edit', item);
            getEl('delete-item-btn').onclick = () => deleteComponent(item.id);

            // Button Stok Masuk/Keluar
            getEl('stock-in-btn').onclick = () => openStockModal('IN', item);
            getEl('stock-out-btn').onclick = () => openStockModal('OUT', item);
            
            // Render Riwayat Transaksi
            const itemHistory = transactions
                .filter(t => t.componentId === selectedComponentId)
                // Sort array in memory
                .sort((a, b) => {
                    const dateA = a.timestamp?.seconds || 0;
                    const dateB = b.timestamp?.seconds || 0;
                    return dateB - dateA;
                });

            historyEl.innerHTML = '';
            if (itemHistory.length === 0) {
                historyEl.innerHTML = '<p class="text-center text-gray-500 p-4">Belum ada riwayat transaksi.</p>';
            } else {
                itemHistory.forEach(t => {
                    const isIN = t.type === 'IN';
                    const colorClass = isIN ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const sign = isIN ? '+' : '-';
                    const date = t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A';

                    historyEl.innerHTML += `
                        <div class="p-3 border-b last:border-b-0 flex justify-between items-center ${isIN ? 'hover:bg-green-50' : 'hover:bg-red-50'} transition">
                            <div>
                                <span class="font-bold ${isIN ? 'text-green-600' : 'text-red-600'}">${isIN ? 'Stok Masuk' : 'Stok Keluar'}</span>
                                <p class="text-xs text-gray-500">Oleh: ${t.pic}</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold ${isIN ? 'text-green-700' : 'text-red-700'}">${sign}${t.quantity} ${item.unit}</span>
                                <p class="text-sm text-gray-600">Sisa: ${t.newStock}</p>
                                <p class="text-xs text-gray-500 mt-1 italic break-all max-w-[150px]">${t.notes}</p>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // --- Modals ---

        const openItemFormModal = (mode, item = {}) => {
            const formModal = getEl('item-form-modal');
            const formTitle = getEl('item-form-title');
            formModal.dataset.mode = mode;

            // Reset form
            getEl('item-id').value = '';
            getEl('item-name').value = '';
            getEl('item-category').value = 'Resistor';
            getEl('item-value').value = '';
            getEl('item-package').value = '';
            getEl('item-brand').value = '';
            getEl('item-location').value = '';
            getEl('item-minstock').value = '0';
            getEl('item-unit').value = 'pcs';
            getEl('item-barcode').value = '';
            getEl('item-id').readOnly = false;

            if (mode === 'edit') {
                formTitle.textContent = 'Edit Komponen: ' + item.name;
                getEl('item-id').value = item.itemId || '';
                getEl('item-name').value = item.name || '';
                getEl('item-category').value = item.category || 'Resistor';
                getEl('item-value').value = item.value || '';
                getEl('item-package').value = item.package || '';
                getEl('item-brand').value = item.brand || '';
                getEl('item-location').value = item.location || '';
                getEl('item-minstock').value = item.minStock || 0;
                getEl('item-unit').value = item.unit || 'pcs';
                getEl('item-barcode').value = item.barcodeContent || item.itemId || '';
                getEl('item-id').readOnly = true; // Jangan izinkan edit ID di mode edit
            } else {
                // add mode
                formTitle.textContent = 'Tambah Komponen Baru';
            }

            formModal.classList.remove('hidden');
        };

        const openStockModal = (type, item) => {
            const modal = getEl('stock-modal');
            getEl('stock-type').value = type;
            getEl('stock-title').textContent = type === 'IN' ? 'Stok Masuk' : 'Stok Keluar';
            getEl('stock-component-name').textContent = item.name;
            getEl('stock-current-stock').textContent = `${item.stock} ${item.unit}`;
            getEl('stock-quantity').value = '';
            getEl('stock-notes').value = '';
            modal.classList.remove('hidden');
        };

        // --- Event Listeners UI Global ---

        // Tambahkan listener untuk logout mode mobile
        const logoutBtnMobile = getEl('logout-btn-mobile');
        if (logoutBtnMobile) {
            logoutBtnMobile.onclick = async () => {
                try {
                    await signOut(auth);
                    showMessageModal('Informasi', 'Anda telah berhasil Logout.');
                } catch (error) {
                    showMessageModal('Error Logout', error.message);
                }
            };
        }

        // Navigasi
        const handleNavClick = (viewName) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            getEl(`nav-${viewName}`).classList.add('active');
            showView(viewName);
        };

        getEl('nav-dashboard').onclick = () => handleNavClick('dashboard');
        getEl('nav-list').onclick = () => handleNavClick('list');
        getEl('nav-scan').onclick = () => handleNavClick('scan');

        getEl('sidebar-toggle-btn').onclick = toggleSidebar;

        // Pencarian Cepat
        getEl('search-input').oninput = (e) => renderInventoryList(e.target.value);

        // Tombol Tambah Komponen
        getEl('add-item-btn').onclick = () => openItemFormModal('add');

        // Tombol Simpan Komponen
        getEl('save-item-btn').onclick = saveComponent;

        // Tombol Simpan Transaksi
        getEl('save-stock-btn').onclick = updateStock;
        
        // Tombol Konfigurasi Firebase
        getEl('toggle-config-btn').onclick = toggleFirebaseConfigForm;
        getEl('save-config-btn').onclick = saveFirebaseConfig;

        // Tombol Tutup Modal
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.onclick = closeModal;
        });

        // Tombol Tutup Modal Pesan (Penting untuk mengatasi masalah logout)
        getEl('message-modal-close-btn').onclick = closeModal;

        // FIX: Tombol Kembali di Detail View (Mengatasi masalah scope module dan memperbarui navigasi aktif)
        const backToListBtn = getEl('back-to-list-btn');
        if (backToListBtn) {
            backToListBtn.onclick = () => {
                // Panggil showView
                showView('list');
                // Perbarui status aktif navigasi (secara manual, karena tidak menggunakan handleNavClick)
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                getEl('nav-list').classList.add('active');
            };
        }

        // --- Logika Tampilkan Password ---
        const togglePasswordBtn = getEl('toggle-password');
        if (togglePasswordBtn) {
            togglePasswordBtn.onclick = () => {
                const passwordInput = getEl('login-password');
                const eyeIcon = togglePasswordBtn.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.setAttribute('data-lucide', 'eye-off');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.setAttribute('data-lucide', 'eye');
                }
                lucide.createIcons();
            };
        }

        // Load Barcode Scanner Library (html5-qrcode)
        const loadScannerLibrary = (callback = null) => {
             if (typeof Html5Qrcode === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/html5-qrcode';
                document.head.appendChild(script);
                script.onload = () => {
                    console.log('html5-qrcode loaded.');
                    // Set the global reference after successful load
                    Html5Qrcode = window.Html5Qrcode;
                    if (callback) callback();
                };
                script.onerror = () => {
                    console.error('Failed to load html5-qrcode.');
                };
            } else if (callback) {
                callback();
            }
        };

        // Inisialisasi awal aplikasi
        window.addEventListener('DOMContentLoaded', () => {
            // 1. Muat library scanner secara non-blocking
            loadScannerLibrary();
            
            // 2. Terapkan status sidebar awal
            document.body.classList.add('sidebar-open');
            // Pastikan toggle-icon ada sebelum mencoba mengaksesnya
            const toggleIcon = getEl('toggle-icon');
            if (toggleIcon) {
                toggleIcon.setAttribute('data-lucide', 'chevrons-left'); // Set icon awal
            }
            
            // 3. Cek apakah ada email yang diingat
            const savedEmail = localStorage.getItem('eims_remembered_email');
            if (savedEmail) {
                getEl('login-email').value = savedEmail;
                getEl('remember-me').checked = true;
            }

            // 4. Jika auth belum terinisialisasi (misal, karena error config), pastikan di login view.
            if (!auth || !auth.currentUser) {
                showView('login');
            }
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        :root {
            font-family: 'Inter', sans-serif;
        }

        /* General Transition Definition for Sidebar and Content */
        .sidebar {
            transition: width 0.3s ease;
        }
        .content {
            transition: padding-left 0.3s ease;
        }

        /* Custom Print Style for Barcode Label (32mm x 64mm) */
        @page {
            /* Landscape: width 64mm, height 32mm */
            size: 64mm 32mm;
            margin: 0;
        }

        @media print {
            /* Sembunyikan semua elemen kecuali container label untuk cetak */
            body > *:not(.print-label-container) {
                display: none !important;
            }

            .print-label-container {
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                /* Ukuran kertas */
                width: 64mm;
                height: 32mm;
                /* Reset standard print styles */
                margin: 0;
                padding: 1mm; /* Padding kecil agar tidak terlalu mepet tepi */
                box-sizing: border-box;
            }

            /* Styling untuk SVG Barcode di mode cetak */
            .print-label-container svg {
                max-width: 60mm;
                height: 20mm; /* Atur ketinggian barcode */
                margin-top: 0;
            }

            /* Styling untuk Nama/ID Barang di mode cetak */
            .print-label-container .print-name {
                font-size: 8pt; /* Ukuran font kecil untuk nama */
                line-height: 1.1;
                margin-top: 1mm;
                font-weight: bold;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
            }

            .print-label-container .print-id {
                font-size: 7pt; /* Ukuran font lebih kecil untuk ID */
                line-height: 1;
                text-align: center;
                margin-bottom: 0;
                font-family: monospace;
            }

            /* Force the element to the top of the page */
            html, body {
                height: 100%;
                overflow: hidden;
            }
        }

        /* Responsive for mobile (Sidebar becomes bottom bar) */
        /* Responsive for mobile (Sidebar becomes bottom bar with icons only) */
@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: fixed;
        bottom: 0;
        z-index: 50;
        padding: 0.5rem;
    }
    .content {
        padding-bottom: 80px; /* Beri ruang agar konten tidak tertutup bar */
    }
    
    /* Hilangkan semua teks & elemen dekoratif */
    .nav-label, #sidebar-title, #sidebar-subtitle, .sidebar-footer, hr, #sidebar-toggle-btn {
        display: none !important;
    }

    /* Atur menu agar horizontal merata */
    .sidebar div.flex-grow {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        width: 100%;
    }

    .nav-item {
        padding: 0.75rem !important;
        margin: 0 !important;
        justify-content: center;
        flex: 1;
    }
    .nav-item i {
        margin-right: 0 !important;
    }
    
    /* Sembunyikan tombol tambah teks jika mengganggu, gunakan ikon saja */
    #add-item-btn {
        background-color: transparent !important; /* Agar tidak putih kotak besar */
        border: none !important;
        color: #4b5563 !important;
        padding: 0.75rem !important;
        flex: 1;
        justify-content: center;
    }
     #add-item-btn span {
         display: none;
     }
}

/* Logic Sidebar Open/Closed on Desktop */
@media (min-width: 769px) {
    .sidebar-open .sidebar {
        width: 260px;
    }
    .sidebar-open .content {
        padding-left: 260px;
    }
    .sidebar-closed .sidebar {
        width: 80px;
    }
    .sidebar-closed .content {
        padding-left: 80px;
    }
    
    /* Hide labels when closed */
    .sidebar-closed .nav-label, 
    .sidebar-closed #sidebar-title, 
    .sidebar-closed #sidebar-subtitle,
    .sidebar-closed .sidebar-footer div:not(#logout-btn),
    .sidebar-closed hr {
        display: none;
    }
    
    .sidebar-closed .nav-item {
        justify-content: center;
        padding: 0.75rem;
    }
    .sidebar-closed .nav-item i {
        margin-right: 0;
    }

    .sidebar-closed #add-item-btn {
        justify-content: center;
    }
    .sidebar-closed #add-item-btn span {
        display: none;
    }
}

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.75rem;
            color: #4b5563;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .nav-item.active {
            background-color: #3b82f6;
            color: white;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen sidebar-open">

    <nav id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-white border-r z-40 flex flex-col hidden">
        <div class="p-6">
            <h1 id="sidebar-title" class="text-2xl font-black text-blue-600 tracking-tighter">E-IMS</h1>
            <p id="sidebar-subtitle" class="text-xs text-gray-500 font-medium">Electronic Inventory</p>
        </div>

        <div class="flex-grow">
            <div id="nav-dashboard" class="nav-item active">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                <span class="nav-label">Dashboard</span>
            </div>
            <div id="nav-list" class="nav-item">
                <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                <span class="nav-label">Daftar Stok</span>
            </div>
            <div id="nav-scan" class="nav-item">
                <i data-lucide="scan-barcode" class="w-5 h-5 mr-3"></i>
                <span class="nav-label">Scan Barcode</span>
            </div>
            
            <hr class="my-4 border-gray-100">
            
            <button id="add-item-btn" class="nav-item w-full flex items-center bg-white text-gray-700 hover:bg-gray-100">
                <i data-lucide="plus-circle" class="w-5 h-5 mr-3 text-blue-500"></i>
                <span class="nav-label">Tambah Komponen</span>
            </button>
        </div>

        <div class="p-4 border-t sidebar-footer">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs" id="user-avatar">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-xs font-bold text-gray-800 truncate" id="user-info">Memuat...</p>
                    <p class="text-[10px] text-gray-500">Teknisi</p>
                </div>
            </div>
            <div id="logout-btn" class="nav-item text-red-600 hover:bg-red-50 m-0">
                <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                <span class="nav-label">Keluar</span>
            </div>
        </div>
    </nav>

    <main class="content min-h-screen">
        <header class="bg-white border-b sticky top-0 z-30 p-4 flex items-center justify-between">
            <button id="sidebar-toggle-btn" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500">
                <i id="toggle-icon" data-lucide="chevrons-left" class="w-6 h-6"></i>
            </button>
            <div class="flex-grow max-w-md mx-4">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Cari nama, spek, atau lokasi..." class="w-full bg-gray-100 border-none rounded-full py-2 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 text-sm transition-all">
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white shadow-sm">
                    <i data-lucide="cpu" class="w-4 h-4"></i>
                </div>
            </div>
        </header>

        <div class="p-4 md:p-8 max-w-6xl mx-auto">
            
            <div id="login-view" class="app-view hidden">
                <div class="flex flex-col items-center justify-center min-h-[70vh]">
                    <div class="card w-full max-w-md p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-white shadow-lg mb-4">
                                <i data-lucide="shield-check" class="w-10 h-10"></i>
                            </div>
                            <h2 class="text-3xl font-black text-gray-800">E-IMS Access</h2>
                            <p class="text-gray-500">Sistem Inventaris Komponen Elektronik</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input type="email" id="login-email" placeholder="teknisi@perusahaan.com" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
                                <div class="relative">
                                    <input type="password" id="login-password" placeholder="" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none pr-10">
                                    <button id="toggle-password" type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-500">
                                        <i data-lucide="eye" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="remember-me" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-700">Ingat saya</label>
                            </div>
                            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">Masuk Sistem</button>
                            <button id="register-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl transition mt-2">Daftar Akun Baru</button>
                        </div>
                        
                        <div class="mt-8 pt-6 border-t border-gray-100">
                            <button id="toggle-config-btn" class="text-xs text-gray-400 hover:text-blue-500 flex items-center mx-auto">
                                <i data-lucide="settings" class="w-4 h-4 mr-1"></i> Konfigurasi Lanjut
                            </button>
                            
                            <div id="firebase-config-form" class="hidden mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
                                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Firebase Cloud Config</p>
                                <input type="text" id="config-apikey" placeholder="API Key" class="w-full text-xs p-2 border rounded">
                                <input type="text" id="config-projectid" placeholder="Project ID" class="w-full text-xs p-2 border rounded">
                                <input type="text" id="config-authdomain" placeholder="Auth Domain (Optional)" class="w-full text-xs p-2 border rounded">
                                <button id="save-config-btn" class="w-full bg-gray-800 text-white text-xs py-2 rounded">Simpan & Muat Ulang</button>
                                <p class="text-[9px] text-red-400 italic text-center leading-tight mt-1">Gunakan ini hanya jika Anda ingin menghubungkan aplikasi ke database Firebase milik sendiri.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard-view" class="app-view">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-800">Dashboard</h2>
                    <p class="text-gray-500">Ringkasan status inventaris saat ini.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 border-l-8 border-blue-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Item</p>
                                <h3 id="total-items" class="text-4xl font-black text-gray-800">0</h3>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-600">
                                <i data-lucide="layers" class="w-8 h-8"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card p-6 border-l-8 border-green-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Unit Stok</p>
                                <h3 id="total-stock" class="text-4xl font-black text-gray-800">0</h3>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl text-green-600">
                                <i data-lucide="box" class="w-8 h-8"></i>
                            </div>
                        </div>
                    </div>
                    <div id="low-stock-alert" class="card p-6 border-l-8 border-red-500 bg-red-50 hidden">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-red-600 uppercase tracking-wider">Stok Menipis</p>
                                <h3 id="low-stock-count" class="text-4xl font-black text-red-700">0</h3>
                            </div>
                            <div class="p-3 bg-red-100 rounded-xl text-red-600">
                                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card overflow-hidden">
                    <div class="p-6 border-b bg-gray-50">
                        <h4 class="font-bold text-gray-700 flex items-center">
                            <i data-lucide="alert-circle" class="w-5 h-5 mr-2 text-red-500"></i>
                            Peringatan Stok Minimum
                        </h4>
                    </div>
                    <ul id="low-stock-list" class="divide-y divide-gray-100 p-4 space-y-2">
                        </ul>
                </div>
            </div>

            <div id="list-view" class="app-view hidden">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800">Daftar Stok</h2>
                        <p class="text-gray-500">Kelola database komponen elektronik Anda.</p>
                    </div>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg transition flex items-center" onclick="document.getElementById('add-item-btn').click()">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Baru
                    </button>
                </div>
                <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="scan-view" class="app-view hidden">
                <div class="mb-8 text-center">
                    <h2 class="text-3xl font-black text-gray-800">Pemindai Barcode</h2>
                    <p class="text-gray-500">Scan label barang untuk update stok cepat.</p>
                </div>
                <div class="card max-w-xl mx-auto overflow-hidden">
                    <div id="reader" class="w-full bg-black aspect-video"></div>
                    <div class="p-6">
                        <div id="scanner-result" class="text-center p-4 bg-gray-100 rounded-xl mb-4 text-sm text-gray-600 min-h-[60px] flex items-center justify-center">
                            Siapkan Barcode komponen...
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="startScanner()" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center">
                                <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i> Ulangi Scan
                            </button>
                            <button onclick="stopScanner()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl flex items-center justify-center">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="detail-view" class="app-view hidden">
                <div class="mb-6">
                    <button id="back-to-list-btn" class="flex items-center text-blue-600 font-bold hover:underline mb-4">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> Kembali ke Daftar
                    </button>
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <img id="detail-photo" src="" alt="Foto Komponen" class="w-20 h-20 object-cover rounded-2xl shadow-md border-2 border-white">
                            <div>
                                <h2 id="detail-name" class="text-3xl font-black text-gray-800 leading-tight">Nama Barang</h2>
                                <p id="detail-id" class="font-mono text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded inline-block mt-1 uppercase tracking-widest">ID-BARANG</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="edit-item-btn" class="bg-white border hover:bg-gray-50 p-3 rounded-xl text-gray-600 shadow-sm transition">
                                <i data-lucide="edit-3" class="w-5 h-5"></i>
                            </button>
                            <button id="delete-item-btn" class="bg-white border hover:bg-red-50 p-3 rounded-xl text-red-500 shadow-sm transition">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-8">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Spesifikasi</p>
                                    <p id="detail-value" class="text-lg font-bold text-gray-800">N/A</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Package</p>
                                    <p id="detail-package" class="text-lg font-bold text-gray-800">N/A</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Brand/Merk</p>
                                    <p id="detail-brand" class="text-lg font-bold text-gray-800">N/A</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Lokasi Rak</p>
                                    <p id="detail-location" class="text-lg font-bold text-blue-600">N/A</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Min. Stok</p>
                                    <p id="detail-minstock" class="text-lg font-bold text-gray-800">0</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Status</p>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">AKTIF</span>
                                </div>
                            </div>
                        </div>

                        <div class="card overflow-hidden">
                            <div class="p-6 border-b bg-gray-50 flex justify-between items-center">
                                <h4 class="font-bold text-gray-700">Riwayat Mutasi Stok</h4>
                                <i data-lucide="history" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <div id="item-history" class="max-h-[400px] overflow-y-auto">
                                </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="card p-8 bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-xl">
                            <p class="text-sm font-bold opacity-80 uppercase tracking-widest">Stok Tersedia</p>
                            <div class="flex items-baseline space-x-2 mt-2">
                                <h3 id="detail-stock" class="text-6xl font-black">0</h3>
                                <span id="detail-unit" class="text-xl font-bold opacity-80">pcs</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mt-8">
                                <button id="stock-in-btn" class="bg-white/20 hover:bg-white/30 backdrop-blur-md py-3 rounded-xl font-bold text-sm transition flex flex-col items-center">
                                    <i data-lucide="arrow-down-left" class="w-6 h-6 mb-1"></i> Stok Masuk
                                </button>
                                <button id="stock-out-btn" class="bg-white/20 hover:bg-white/30 backdrop-blur-md py-3 rounded-xl font-bold text-sm transition flex flex-col items-center">
                                    <i data-lucide="arrow-up-right" class="w-6 h-6 mb-1"></i> Stok Keluar
                                </button>
                            </div>
                        </div>

                        <div id="barcode-display">
                            </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="item-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                <h3 id="item-form-title" class="text-xl font-black text-gray-800">Tambah Komponen</h3>
                <button class="close-modal-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Kode Barang / Part Number</label>
                        <input type="text" id="item-id" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono" placeholder="Cth: RES-10K-0603">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Barcode Content (Opsional)</label>
                        <input type="text" id="item-barcode" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Isi jika beda dengan Kode Barang">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Nama Komponen</label>
                        <input type="text" id="item-name" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: Resistor SMD 10K Ohm">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Kategori</label>
                        <select id="item-category" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="Resistor">Resistor</option>
                            <option value="Kapasitor">Kapasitor</option>
                            <option value="IC">IC (Integrated Circuit)</option>
                            <option value="Transistor">Transistor / Mosfet</option>
                            <option value="Dioda">Dioda</option>
                            <option value="Connector">Connector</option>
                            <option value="Module">Sensor / Module</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Spesifikasi / Nilai</label>
                        <input type="text" id="item-value" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: 10K, 100uF 50V, ESP32">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Package (Ukuran)</label>
                        <input type="text" id="item-package" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: 0603, 0805, TO-220, DIP-8">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Merk / Brand</label>
                        <input type="text" id="item-brand" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: Yageo, Samsung, ST">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Lokasi Penyimpanan</label>
                        <input type="text" id="item-location" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cth: Rak A-12, Box 3">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Batas Stok Minimum</label>
                        <input type="number" id="item-minstock" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Satuan</label>
                        <input type="text" id="item-unit" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="pcs, reel, box">
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3 bg-gray-50 rounded-b-2xl">
                <button class="close-modal-btn px-6 py-3 font-bold text-gray-600 hover:text-gray-800 transition">Batal</button>
                <button id="save-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-3 rounded-xl shadow-lg transition transform active:scale-95">Simpan Data</button>
            </div>
        </div>
    </div>

    <div id="stock-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 id="stock-title" class="text-2xl font-black text-gray-800">Update Stok</h3>
                <button class="close-modal-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            
            <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                <p class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-1">Komponen</p>
                <p id="stock-component-name" class="text-lg font-bold text-gray-800">Nama Barang</p>
                <p class="text-sm text-gray-600">Stok saat ini: <span id="stock-current-stock" class="font-bold">0 pcs</span></p>
            </div>

            <input type="hidden" id="stock-type">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Jumlah Perubahan</label>
                    <input type="number" id="stock-quantity" class="w-full border-2 p-4 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-2xl font-black text-center" placeholder="0">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Catatan / Keperluan</label>
                    <textarea id="stock-notes" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="Contoh: Produksi Board X, Pembelian baru, dll"></textarea>
                </div>
                <button id="save-stock-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition transform active:scale-95">Proses Transaksi</button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center animate-in zoom-in duration-200">
            <div id="modal-icon" class="w-16 h-16 bg-blue-100 rounded-full mx-auto flex items-center justify-center text-blue-600 mb-4">
                <i data-lucide="info" class="w-8 h-8"></i>
            </div>
            <h3 id="modal-title" class="text-2xl font-black text-gray-800 mb-2">Pesan</h3>
            <p id="modal-message" class="text-gray-600 mb-6 leading-relaxed">Isi pesan di sini...</p>
            <button id="message-modal-close-btn" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 rounded-xl transition">Mengerti</button>
        </div>
    </div>

    <script>
        // Memastikan Lucide icons ter-render pada load awal
        window.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
